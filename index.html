<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO基本設定 -->
    <title>ゆるマーケ道場 - マーケティング学習クイズアプリ | SEO・広告・AI問題で実力アップ</title>
    <meta name="description" content="マーケティングスキルを楽しく学べるクイズアプリ。SEO、広告運用、AI活用など実践的な問題で知識を深めよう。無料プランから始められ、プレミアムプランで上級問題にも挑戦可能。">
    <meta name="keywords" content="マーケティング,クイズ,SEO,広告,AI,学習,スキルアップ,デジタルマーケティング,オンライン学習">
    <meta name="author" content="ゆるマーケ道場">
    <meta name="robots" content="index, follow">
    <meta name="language" content="ja">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/">
    <meta property="og:title" content="ゆるマーケ道場 - マーケティング学習クイズアプリ">
    <meta property="og:description" content="マーケティングスキルを楽しく学べるクイズアプリ。SEO、広告運用、AI活用など実践的な問題で知識を深めよう。">
    <meta property="og:image" content="https://example.com/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="ゆるマーケ道場">
    <meta property="og:locale" content="ja_JP">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://example.com/">
    <meta name="twitter:title" content="ゆるマーケ道場 - マーケティング学習クイズアプリ">
    <meta name="twitter:description" content="マーケティングスキルを楽しく学べるクイズアプリ。SEO、広告運用、AI活用など実践的な問題で知識を深めよう。">
    <meta name="twitter:image" content="https://example.com/twitter-image.jpg">
    <meta name="twitter:creator" content="@yurumarket">
    
    <!-- 構造化データ（JSON-LD） -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "ゆるマーケ道場",
        "description": "マーケティングスキルを楽しく学べるクイズアプリ。SEO、広告運用、AI活用など実践的な問題で知識を深めよう。",
        "url": "https://example.com/",
        "applicationCategory": "EducationalApplication",
        "operatingSystem": "Web Browser",
        "offers": [
            {
                "@type": "Offer",
                "name": "無料プラン",
                "price": "0",
                "priceCurrency": "JPY",
                "description": "初級問題にアクセス可能"
            },
            {
                "@type": "Offer",
                "name": "プレミアムプラン",
                "price": "980",
                "priceCurrency": "JPY",
                "description": "全難易度の問題にアクセス、詳細解説付き"
            }
        ],
        "author": {
            "@type": "Organization",
            "name": "ゆるマーケ道場",
            "url": "https://example.com/"
        },
        "publisher": {
            "@type": "Organization",
            "name": "ゆるマーケ道場",
            "url": "https://example.com/"
        },
        "inLanguage": "ja",
        "isAccessibleForFree": true,
        "hasPart": [
            {
                "@type": "Course",
                "name": "SEO基礎コース",
                "description": "検索エンジン最適化の基本を学ぶ"
            },
            {
                "@type": "Course", 
                "name": "広告運用コース",
                "description": "デジタル広告の運用方法を学ぶ"
            },
            {
                "@type": "Course",
                "name": "AI活用コース", 
                "description": "マーケティングでのAI活用方法を学ぶ"
            }
        ]
    }
    </script>
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://example.com/">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXX" crossorigin="anonymous"></script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>
    
    <!-- Google Sign-In API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #00c4cc 0%, #7b68ee 50%, #ff6b9d 100%);
            min-height: 100vh;
        }
        .canva-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .quiz-card {
            background: linear-gradient(135deg, #00c4cc 0%, #7b68ee 100%);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        .quiz-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
            pointer-events: none;
        }
        .option-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            /* タッチ操作最適化 */
            min-height: 44px; /* iOS推奨タッチターゲットサイズ */
            touch-action: manipulation; /* ダブルタップズーム無効化 */
            -webkit-tap-highlight-color: transparent; /* タップハイライト除去 */
            user-select: none; /* テキスト選択防止 */
        }
        .option-button:hover,
        .option-button:focus {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 196, 204, 0.3);
            border-color: #00c4cc;
            outline: none;
        }
        /* タッチデバイス用のアクティブ状態 */
        .option-button:active {
            transform: translateY(-1px);
            transition-duration: 0.1s;
        }
        /* モバイル専用スタイル */
        @media (max-width: 768px) {
            .option-button {
                min-height: 48px; /* モバイルでより大きなタッチターゲット */
                font-size: 16px; /* iOS自動ズーム防止 */
            }
        }
        .option-selected {
            background: linear-gradient(135deg, #00c4cc, #7b68ee) !important;
            color: white !important;
            border-color: #00c4cc !important;
        }
        .correct { 
            background: linear-gradient(135deg, #00d4aa, #00c4cc) !important; 
            animation: correctPulse 0.6s ease-out;
        }
        .incorrect { 
            background: linear-gradient(135deg, #ff6b9d, #ff8a80) !important; 
            animation: incorrectShake 0.6s ease-out;
        }
        .progress-bar {
            background: linear-gradient(90deg, #00c4cc, #7b68ee, #ff6b9d);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        .canva-button {
            background: linear-gradient(135deg, #00c4cc, #7b68ee);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            /* タッチ操作最適化 */
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .canva-button:hover,
        .canva-button:focus {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 196, 204, 0.4);
            outline: 2px solid #00c4cc;
            outline-offset: 2px;
        }
        .canva-button:active {
            transform: translateY(0px);
            transition-duration: 0.1s;
        }
        @media (max-width: 768px) {
            .canva-button {
                min-height: 48px;
                font-size: 16px;
            }
        }
        .canva-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .canva-button:hover::before {
            left: 100%;
        }
        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        .shape:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
        .shape:nth-child(2) { top: 20%; right: 10%; animation-delay: 2s; }
        .shape:nth-child(3) { bottom: 20%; left: 20%; animation-delay: 4s; }
        .shape:nth-child(4) { bottom: 10%; right: 20%; animation-delay: 1s; }
        
        /* 新しいアニメーション効果 */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        .bounce-in {
            animation: bounceIn 0.8s ease-out;
        }
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ff6b9d;
            animation: confettiFall 3s linear infinite;
            z-index: 1000;
        }
        .confetti:nth-child(odd) { background: #00c4cc; }
        .confetti:nth-child(3n) { background: #7b68ee; }
        .confetti:nth-child(4n) { background: #00d4aa; }
        
        /* パーティクル効果 */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            pointer-events: none;
            animation: particleFloat 2s ease-out forwards;
        }
        
        /* SEO用のスクリーンリーダー専用クラス */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* 細かいブレークポイント対応 */
        /* 極小デバイス (320px以下) */
        @media (max-width: 320px) {
            .container { padding: 8px; }
            .canva-card { padding: 12px; }
            .text-4xl { font-size: 1.875rem; }
            .text-3xl { font-size: 1.5rem; }
            .text-2xl { font-size: 1.25rem; }
        }
        
        /* 小型スマートフォン (321px - 480px) */
        @media (min-width: 321px) and (max-width: 480px) {
            .container { padding: 12px; }
            .canva-card { padding: 16px; }
        }
        
        /* 大型スマートフォン (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            .container { padding: 16px; }
            .canva-card { padding: 20px; }
        }
        
        /* 小型タブレット (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container { padding: 20px; }
            .canva-card { padding: 24px; }
        }
        
        /* 大型タブレット・小型デスクトップ (1025px - 1440px) */
        @media (min-width: 1025px) and (max-width: 1440px) {
            .container { padding: 24px; }
            .canva-card { padding: 32px; }
        }
        
        /* 大型デスクトップ (1441px以上) */
        @media (min-width: 1441px) {
            .container { max-width: 1200px; }
            .canva-card { padding: 40px; }
        }
        
        /* 横向きスマートフォン対応 */
        @media (max-height: 500px) and (orientation: landscape) {
            .text-6xl { font-size: 2rem; }
            .text-5xl { font-size: 1.875rem; }
            .py-8 { padding-top: 1rem; padding-bottom: 1rem; }
            .mb-8 { margin-bottom: 1rem; }
        }
        
        /* 広告スタイル */
        .ad-container {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin: 16px 0;
        }
        .ad-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        /* キーボード操作・アクセシビリティ改善 */
        /* フォーカス可能な要素の基本スタイル */
        button, input, select, textarea, [tabindex]:not([tabindex="-1"]) {
            outline: none;
        }
        
        /* 高コントラストフォーカスリング */
        button:focus-visible, 
        input:focus-visible, 
        select:focus-visible, 
        textarea:focus-visible,
        [tabindex]:focus-visible {
            outline: 3px solid #0066cc;
            outline-offset: 2px;
            box-shadow: 0 0 0 1px #ffffff;
        }
        
        /* ボタンのキーボード操作 */
        .option-button:focus-visible {
            outline: 3px solid #0066cc;
            outline-offset: 2px;
            box-shadow: 0 0 0 1px #ffffff, 0 12px 40px rgba(0, 196, 204, 0.3);
            border-color: #00c4cc;
        }
        
        /* スキップリンク */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #000;
            color: #fff;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 1000;
            font-weight: bold;
        }
        .skip-link:focus {
            top: 6px;
        }
        
        /* 高コントラスト対応 */
        @media (prefers-contrast: high) {
            .canva-card {
                border: 2px solid #000;
                background: #fff;
            }
            .option-button {
                border: 2px solid #000;
                background: #fff;
                color: #000;
            }
            .canva-button {
                background: #000;
                color: #fff;
                border: 2px solid #000;
            }
        }
        
        /* 動きを減らす設定への対応 */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            .floating-shapes {
                display: none;
            }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 196, 204, 0.3); }
            50% { box-shadow: 0 0 40px rgba(0, 196, 204, 0.6); }
        }
        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        @keyframes particleFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0); opacity: 0; }
        }
        
        /* ダークモード対応 */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: rgba(45, 45, 45, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #808080;
            --border-color: #404040;
            --accent-primary: #00c4cc;
            --accent-secondary: #7b68ee;
        }
        
        [data-theme="light"] {
            --bg-primary: linear-gradient(135deg, #00c4cc 0%, #7b68ee 50%, #ff6b9d 100%);
            --bg-secondary: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.95);
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --accent-primary: #00c4cc;
            --accent-secondary: #7b68ee;
        }
        
        /* ダークモード時のbody背景 */
        [data-theme="dark"] body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #404040 100%);
            color: var(--text-primary);
        }
        
        /* ダークモード時のカード */
        [data-theme="dark"] .canva-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        /* ダークモード時のテキスト */
        [data-theme="dark"] .text-gray-800 { color: var(--text-primary) !important; }
        [data-theme="dark"] .text-gray-700 { color: var(--text-secondary) !important; }
        [data-theme="dark"] .text-gray-600 { color: var(--text-muted) !important; }
        [data-theme="dark"] .text-gray-500 { color: var(--text-muted) !important; }
        
        /* ダークモード時のボタン */
        [data-theme="dark"] .option-button {
            background: rgba(45, 45, 45, 0.9);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        [data-theme="dark"] .option-button:hover {
            background: rgba(60, 60, 60, 0.9);
            border-color: var(--accent-primary);
        }
        
        /* ダークモード時の入力フィールド */
        [data-theme="dark"] input, 
        [data-theme="dark"] select, 
        [data-theme="dark"] textarea {
            background: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        [data-theme="dark"] input:focus,
        [data-theme="dark"] select:focus,
        [data-theme="dark"] textarea:focus {
            border-color: var(--accent-primary);
            background: rgba(45, 45, 45, 0.8);
        }
        
        /* ダークモード時の広告 */
        [data-theme="dark"] .ad-container {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        /* ダークモード時のフッター */
        [data-theme="dark"] footer {
            background: #0f0f0f;
        }
        
        /* テーマ切り替えボタン */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
        }
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(0, 196, 204, 0.3);
        }
        
        /* システム設定に従う場合の初期設定 */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --bg-card: rgba(45, 45, 45, 0.95);
                --text-primary: #ffffff;
                --text-secondary: #b3b3b3;
                --text-muted: #808080;
                --border-color: #404040;
                --accent-primary: #00c4cc;
                --accent-secondary: #7b68ee;
            }
        }
    </style>
</head>
<body>
    <!-- Floating Background Shapes -->
    <div class="floating-shapes">
        <div class="shape">
            <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
                <circle cx="40" cy="40" r="30" fill="#00c4cc"/>
            </svg>
        </div>
        <div class="shape">
            <svg width="60" height="60" viewBox="0 0 60 60" fill="none">
                <rect x="15" y="15" width="30" height="30" rx="8" fill="#7b68ee"/>
            </svg>
        </div>
        <div class="shape">
            <svg width="70" height="70" viewBox="0 0 70 70" fill="none">
                <polygon points="35,10 55,50 15,50" fill="#ff6b9d"/>
            </svg>
        </div>
        <div class="shape">
            <svg width="50" height="50" viewBox="0 0 50 50" fill="none">
                <path d="M25 5 L45 25 L25 45 L5 25 Z" fill="#00d4aa"/>
            </svg>
        </div>
    </div>
    
    <!-- アクセシビリティ: スキップリンク -->
    <a href="#main-content" class="skip-link">メインコンテンツにスキップ</a>
    
    <!-- テーマ切り替えボタン -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="ダークモード切り替え" title="テーマを切り替える">
        <span id="themeIcon">🌙</span>
    </button>
    
    <div class="container mx-auto px-4 py-8 max-w-4xl relative z-10" id="main-content">
        <!-- SEO用のヘッダー（検索エンジン向け） -->
        <header class="sr-only">
            <h1>ゆるマーケ道場 - マーケティング学習クイズアプリ</h1>
            <p>SEO、広告運用、AI活用など実践的なマーケティング問題で知識を深めよう</p>
        </header>

        <!-- ログイン画面 -->
        <div id="loginContainer" class="canva-card rounded-3xl p-8 mb-8 text-center fade-in">
            <div class="mb-6">
                <h2 class="text-5xl font-bold bg-gradient-to-r from-cyan-500 to-purple-600 bg-clip-text text-transparent mb-3">
                    ✨ ゆるマーケ道場
                </h2>
                <p class="text-gray-700 text-lg font-medium">40代以上の非マーケター、非デジタル社会人向けのWebスキル学習サイト</p>
                
                <!-- 学習イメージ -->
                <div class="my-8 flex justify-center">
                    <div class="relative">
                        <!-- デフォルトのSVGイラスト -->
                        <svg id="defaultIllustration" width="200" height="150" viewBox="0 0 200 150" class="rounded-lg shadow-lg">
                            <!-- 背景 -->
                            <rect width="200" height="150" fill="#f0f9ff"/>
                            
                            <!-- 中年男性（立っている姿勢） -->
                            <!-- 頭 -->
                            <circle cx="60" cy="45" r="18" fill="#fbbf24"/>
                            <!-- 髪（薄め、M字ハゲ風） -->
                            <path d="M 42 40 Q 50 32 60 32 Q 70 32 78 40 Q 75 35 70 35 Q 60 30 50 35 Q 45 35 42 40" fill="#6b7280"/>
                            <!-- 眼鏡 -->
                            <circle cx="55" cy="43" r="4" fill="none" stroke="#374151" stroke-width="1"/>
                            <circle cx="65" cy="43" r="4" fill="none" stroke="#374151" stroke-width="1"/>
                            <line x1="59" y1="43" x2="61" y2="43" stroke="#374151" stroke-width="1"/>
                            
                            <!-- 体（シャツ） -->
                            <rect x="48" y="63" width="24" height="45" rx="3" fill="#3b82f6"/>
                            <!-- 襟 -->
                            <polygon points="48,63 54,63 60,70 66,63 72,63 72,75 48,75" fill="#1e40af"/>
                            
                            <!-- 右腕（スマホを持つ） -->
                            <rect x="72" y="70" width="8" height="25" rx="2" fill="#fbbf24"/>
                            <!-- 右手 -->
                            <circle cx="80" cy="95" r="4" fill="#fbbf24"/>
                            
                            <!-- スマートフォン（手に持っている） -->
                            <rect x="82" y="85" width="25" height="40" rx="4" fill="#1f2937" stroke="#374151" stroke-width="1"/>
                            <rect x="85" y="90" width="19" height="30" fill="#3b82f6"/>
                            
                            <!-- スマホ画面のコンテンツ -->
                            <rect x="87" y="93" width="15" height="3" rx="1" fill="#ffffff" opacity="0.9"/>
                            <rect x="87" y="98" width="12" height="2" rx="1" fill="#ffffff" opacity="0.7"/>
                            <rect x="87" y="102" width="13" height="2" rx="1" fill="#ffffff" opacity="0.7"/>
                            <rect x="87" y="106" width="10" height="2" rx="1" fill="#ffffff" opacity="0.7"/>
                            
                            <!-- 選択肢ボタン -->
                            <rect x="87" y="110" width="15" height="3" rx="1" fill="#10b981" opacity="0.8"/>
                            <rect x="87" y="115" width="15" height="3" rx="1" fill="#ffffff" opacity="0.3"/>
                            
                            <!-- 左腕 -->
                            <rect x="40" y="75" width="8" height="20" rx="2" fill="#fbbf24"/>
                            <!-- 左手 -->
                            <circle cx="40" cy="95" r="3" fill="#fbbf24"/>
                            
                            <!-- 脚 -->
                            <rect x="52" y="108" width="7" height="25" rx="2" fill="#1f2937"/>
                            <rect x="61" y="108" width="7" height="25" rx="2" fill="#1f2937"/>
                            
                            <!-- 靴 -->
                            <ellipse cx="55" cy="135" rx="6" ry="3" fill="#374151"/>
                            <ellipse cx="64" cy="135" rx="6" ry="3" fill="#374151"/>
                            
                            <!-- 笑顔 -->
                            <circle cx="56" cy="42" r="1" fill="#1f2937"/>
                            <circle cx="64" cy="42" r="1" fill="#1f2937"/>
                            <path d="M 54 50 Q 60 54 66 50" stroke="#1f2937" stroke-width="1.2" fill="none"/>
                            
                            <!-- 学習効果のキラキラ -->
                            <text x="120" y="25" font-size="16" fill="#fbbf24">✨</text>
                            <text x="140" y="40" font-size="12" fill="#10b981">💡</text>
                            <text x="125" y="55" font-size="14" fill="#8b5cf6">📚</text>
                            <text x="145" y="70" font-size="12" fill="#f59e0b">🎯</text>
                            
                            <!-- 集中線効果 -->
                            <line x1="110" y1="90" x2="115" y2="85" stroke="#fbbf24" stroke-width="2" opacity="0.6"/>
                            <line x1="115" y1="95" x2="120" y2="90" stroke="#fbbf24" stroke-width="2" opacity="0.6"/>
                            <line x1="110" y1="100" x2="115" y2="105" stroke="#fbbf24" stroke-width="2" opacity="0.6"/>
                            
                            <!-- 「楽しく学習中」テキスト -->
                            <text x="100" y="140" font-size="10" fill="#6b7280" text-anchor="middle">楽しく学習中！</text>
                        </svg>
                        
                        <!-- カスタム画像（設定されている場合） -->
                        <img id="customHeroImage" src="" alt="学習イメージ" class="hidden rounded-lg shadow-lg w-[200px] h-[150px] object-cover">
                        
                        <!-- 管理者のみ：画像変更ボタン -->
                        <button id="changeImageButton" onclick="showImageUploadModal()" class="hidden absolute -bottom-2 -right-2 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full shadow-lg transition-all text-xs">
                            📷
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 広告スペース1 -->
            <div class="ad-container mb-6">
                <div class="ad-label">スポンサー</div>
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg">
                    <h3 class="font-bold mb-2">📚 学習効率UP！</h3>
                    <p class="text-sm">プレミアムプランで詳細解説と進捗分析を体験</p>
                </div>
            </div>
            
            <div class="max-w-md mx-auto">
                <div class="mb-6">
                    <input type="email" id="loginEmail" placeholder="メールアドレス" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent mb-3">
                    <input type="password" id="loginPassword" placeholder="パスワード" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div class="space-y-3">
                    <button onclick="login()" class="canva-button text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg">
                        🔑 ログイン
                    </button>
                    <button onclick="googleLogin()" class="bg-red-500 hover:bg-red-600 text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg transition-all flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Googleでログイン
                    </button>
                    <button onclick="showRegister()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg transition-all">
                        📝 新規登録
                    </button>
                    <button onclick="loginAsGuest()" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg transition-all">
                        👤 ゲストログイン（無料プラン）
                    </button>
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-2">💡 デモ用アカウント</h3>
                    <div class="text-sm text-blue-700 space-y-1">
                        <p><strong>無料プラン:</strong> demo@free.com / password123</p>
                        <p><strong>プレミアムプラン:</strong> demo@premium.com / password123</p>
                        <p><strong>管理者:</strong> admin@demo.com / admin123</p>
                        <p><strong>Googleログイン:</strong> 「Googleでログイン」ボタンをクリック（デモ版）</p>
                    </div>
                    <div class="mt-3 p-2 bg-green-50 rounded text-xs text-green-700">
                        ✨ <strong>新機能:</strong> ログイン状態がページリロード後も保持されます
                    </div>
                </div>
            </div>
        </div>

        <!-- 新規登録画面 -->
        <div id="registerContainer" class="hidden canva-card rounded-3xl p-8 mb-8 text-center fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">📝 新規登録</h2>
            
            <div class="max-w-md mx-auto">
                <div class="mb-6 space-y-3">
                    <input type="text" id="registerName" placeholder="お名前" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <input type="email" id="registerEmail" placeholder="メールアドレス" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <input type="password" id="registerPassword" placeholder="パスワード" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div class="space-y-3">
                    <button onclick="register()" class="canva-button text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg">
                        ✨ 登録する（無料プラン）
                    </button>
                    <button onclick="showLogin()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg transition-all">
                        ← ログイン画面に戻る
                    </button>
                </div>
            </div>
        </div>

        <!-- ヘッダー（ログイン後） -->
        <div id="mainHeader" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                <div class="canva-card rounded-2xl px-4 sm:px-8 py-4 sm:py-6 fade-in w-full sm:w-auto">
                    <h1 class="text-2xl sm:text-4xl font-bold bg-gradient-to-r from-cyan-500 to-purple-600 bg-clip-text text-transparent mb-1 sm:mb-2">
                        ✨ ゆるマーケ道場
                    </h1>
                    <p class="text-gray-700 text-sm sm:text-lg font-medium">40代以上の非マーケター、非デジタル社会人向けのWebスキル学習サイト</p>
                </div>
                
                <div class="canva-card rounded-2xl px-3 sm:px-6 py-3 sm:py-4 fade-in w-full sm:w-auto">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <div class="flex-1 sm:text-right">
                            <div class="font-semibold text-gray-800 text-sm sm:text-base" id="userNameDisplay">ユーザー名</div>
                            <div class="flex items-center justify-start sm:justify-end mt-1">
                                <span id="userPlanDisplay" class="text-xs sm:text-sm px-2 sm:px-3 py-1 rounded-full bg-blue-100 text-blue-600">無料プラン</span>
                                <button id="upgradeButton" onclick="showUpgradeModal()" class="hidden ml-2 text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-2 sm:px-3 py-1 rounded-full hover:shadow-lg transition-all">
                                    ⭐ アップグレード
                                </button>
                            </div>
                        </div>
                        <div class="flex space-x-2 w-full sm:w-auto">
                            <button id="adminButton" onclick="showAdminPanel()" class="hidden flex-1 sm:flex-none bg-purple-500 hover:bg-purple-600 text-white px-3 sm:px-4 py-2 rounded-lg font-medium transition-all text-xs sm:text-sm">
                                ⚙️ 管理
                            </button>
                            <button onclick="showAnalytics()" class="flex-1 sm:flex-none bg-blue-500 hover:bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg font-medium transition-all text-xs sm:text-sm">
                                📊 分析
                            </button>
                            <button onclick="logout()" class="flex-1 sm:flex-none bg-red-500 hover:bg-red-600 text-white px-3 sm:px-4 py-2 rounded-lg font-medium transition-all text-xs sm:text-sm">
                                ログアウト
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ホーム画面 -->
        <main id="homeContainer" class="hidden">
            <!-- ウェルカムセクション -->
            <section class="canva-card rounded-3xl p-6 sm:p-8 mb-6 text-center fade-in">
                <div class="mb-6">
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-6 mb-6">
                        <div class="flex-1">
                            <div class="text-4xl sm:text-6xl mb-4">🏠</div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">マーケティング学習ダッシュボード</h2>
                            <p class="text-gray-600 text-sm sm:text-base">40代以上の非マーケター、非デジタル社会人向けのWebスキル学習サイト</p>
                        </div>
                        
                        <!-- 学習イメージ（ホーム画面用） -->
                        <div class="flex-shrink-0">
                            <svg width="180" height="140" viewBox="0 0 180 140" class="rounded-lg shadow-lg">
                                <!-- 背景 -->
                                <rect width="180" height="140" fill="#f8fafc"/>
                                
                                <!-- デスク -->
                                <rect x="20" y="100" width="140" height="30" rx="4" fill="#8b5cf6" opacity="0.8"/>
                                
                                <!-- スマートフォン -->
                                <rect x="60" y="70" width="45" height="70" rx="6" fill="#1f2937" stroke="#374151" stroke-width="1.5"/>
                                <rect x="64" y="78" width="37" height="54" fill="#3b82f6"/>
                                
                                <!-- スマホ画面のコンテンツ -->
                                <rect x="68" y="82" width="29" height="6" rx="1" fill="#ffffff" opacity="0.9"/>
                                <rect x="68" y="92" width="22" height="4" rx="1" fill="#ffffff" opacity="0.7"/>
                                <rect x="68" y="99" width="26" height="4" rx="1" fill="#ffffff" opacity="0.7"/>
                                <rect x="68" y="106" width="18" height="4" rx="1" fill="#ffffff" opacity="0.7"/>
                                
                                <!-- 選択肢ボタン -->
                                <rect x="68" y="114" width="29" height="6" rx="1" fill="#10b981" opacity="0.8"/>
                                <rect x="68" y="122" width="29" height="6" rx="1" fill="#ffffff" opacity="0.3"/>
                                
                                <!-- 中年男性（座っている） -->
                                <!-- 頭 -->
                                <circle cx="40" cy="60" r="12" fill="#fbbf24"/>
                                <!-- 髪（薄め、サイド分け） -->
                                <path d="M 28 55 Q 40 48 52 55 Q 48 52 40 52 Q 32 52 28 55" fill="#6b7280"/>
                                <!-- 体 -->
                                <rect x="32" y="72" width="16" height="28" rx="2" fill="#059669"/>
                                <!-- 腕（スマホを持つ） -->
                                <rect x="48" y="78" width="12" height="6" rx="1" fill="#fbbf24"/>
                                <rect x="20" y="82" width="12" height="6" rx="1" fill="#fbbf24"/>
                                
                                <!-- 脚 -->
                                <rect x="30" y="100" width="6" height="15" rx="1" fill="#1f2937"/>
                                <rect x="42" y="100" width="6" height="15" rx="1" fill="#1f2937"/>
                                
                                <!-- 笑顔 -->
                                <circle cx="36" cy="58" r="1" fill="#1f2937"/>
                                <circle cx="44" cy="58" r="1" fill="#1f2937"/>
                                <path d="M 34 64 Q 40 67 46 64" stroke="#1f2937" stroke-width="1" fill="none"/>
                                
                                <!-- コーヒーカップ -->
                                <rect x="110" y="85" width="12" height="15" rx="2" fill="#ffffff" stroke="#d1d5db"/>
                                <rect x="112" y="87" width="8" height="11" fill="#8b4513" opacity="0.6"/>
                                <path d="M 122 90 Q 127 90 127 95 Q 127 100 122 100" stroke="#d1d5db" fill="none"/>
                                
                                <!-- 学習効果のキラキラ -->
                                <text x="130" y="25" font-size="14" fill="#fbbf24">✨</text>
                                <text x="145" y="40" font-size="10" fill="#10b981">💡</text>
                                <text x="135" y="55" font-size="12" fill="#8b5cf6">📈</text>
                                <text x="150" y="70" font-size="10" fill="#f59e0b">🎯</text>
                                
                                <!-- 「集中学習中」テキスト -->
                                <text x="90" y="130" font-size="9" fill="#6b7280" text-anchor="middle">集中学習中！</text>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Phase 2: ゲーミフィケーション - レベル・XPバー -->
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 sm:p-6 rounded-2xl mb-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="text-2xl sm:text-3xl mr-3">⭐</div>
                            <div>
                                <div class="text-lg sm:text-xl font-bold" id="userLevelDisplay">Lv.1</div>
                                <div class="text-xs sm:text-sm opacity-90" id="userXPDisplay">0 / 100 XP</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm opacity-90">総XP</div>
                            <div class="text-lg font-bold" id="totalXPDisplay">0</div>
                        </div>
                    </div>
                    <div class="w-full bg-white bg-opacity-20 rounded-full h-3">
                        <div id="xpProgressBar" class="bg-white rounded-full h-3 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- 今日の目標 -->
                <div class="canva-card rounded-2xl p-4 sm:p-6 mb-6">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="text-2xl mr-2">🎯</span>
                        今日の目標
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="dailyGoalsContainer">
                        <!-- 目標がここに動的に生成されます -->
                    </div>
                </div>
                
                <!-- 学習統計サマリー -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 sm:p-4 rounded-xl text-center">
                        <div class="text-lg sm:text-2xl font-bold" id="homeTotalQuizzes">0</div>
                        <div class="text-xs sm:text-sm opacity-90">総クイズ数</div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-3 sm:p-4 rounded-xl text-center">
                        <div class="text-lg sm:text-2xl font-bold" id="homeAverageScore">0%</div>
                        <div class="text-xs sm:text-sm opacity-90">平均正答率</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-3 sm:p-4 rounded-xl text-center">
                        <div class="text-lg sm:text-2xl font-bold" id="homeStreak">0日</div>
                        <div class="text-xs sm:text-sm opacity-90">連続学習</div>
                        <div class="text-xs opacity-75 mt-1">最高: <span id="homeBestStreak">0</span>日</div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-3 sm:p-4 rounded-xl text-center">
                        <div class="text-lg sm:text-2xl font-bold" id="homeLevel">Lv.1</div>
                        <div class="text-xs sm:text-sm opacity-90">現在レベル</div>
                    </div>
                </div>
                
                <!-- 最近獲得したバッジ -->
                <div class="canva-card rounded-2xl p-4 sm:p-6 mb-6" id="recentBadgesSection">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="text-2xl mr-2">🏆</span>
                        最近のバッジ
                        <button onclick="showAllBadges()" class="ml-auto text-sm bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600 transition-all">
                            すべて見る
                        </button>
                    </h3>
                    <div id="recentBadgesContainer" class="flex flex-wrap gap-3">
                        <!-- 最近のバッジがここに表示されます -->
                    </div>
                </div>
                
                <!-- 広告スペース（ホーム画面上部） -->
                <div id="homeAdSpace1" class="ad-container mb-6">
                    <div class="ad-label">おすすめ</div>
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-lg">
                        <h3 class="font-bold mb-2 text-sm sm:text-base">🎯 学習効率を最大化！</h3>
                        <p class="text-xs sm:text-sm">プレミアムプランで詳細解説と高度分析機能を体験</p>
                        <button onclick="showUpgradeModal()" class="mt-2 bg-white text-indigo-600 px-3 py-1 rounded-full text-xs font-medium hover:shadow-lg transition-all">
                            今すぐアップグレード
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- カテゴリ選択 -->
            <section class="canva-card rounded-3xl p-6 sm:p-8 mb-6 fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6 text-center">📚 マーケティング学習カテゴリ</h3>
                <p class="text-center text-gray-600 mb-6 text-sm sm:text-base">実践的なマーケティングスキルを身につけよう</p>
                <div id="categoryGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4">
                    <!-- カテゴリカードがここに動的に生成されます -->
                </div>
            </section>
            
            <!-- 最近の学習履歴 -->
            <section class="canva-card rounded-3xl p-6 sm:p-8 mb-6 fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6">📈 学習進捗と履歴</h3>
                <p class="text-gray-600 mb-4 text-sm sm:text-base">あなたのマーケティング学習の成果を確認しよう</p>
                <div id="recentHistory" class="space-y-3">
                    <!-- 学習履歴がここに表示されます -->
                </div>
            </section>
            
            <!-- 広告スペース（ホーム画面下部） -->
            <div id="homeAdSpace2" class="ad-container mb-6">
                <div class="ad-label">スポンサー</div>
                <div class="bg-gradient-to-r from-pink-500 to-rose-600 text-white p-4 rounded-lg">
                    <h3 class="font-bold mb-2 text-sm sm:text-base">🏆 さらなる高みへ</h3>
                    <p class="text-xs sm:text-sm">上級問題で真のエキスパートを目指そう</p>
                </div>
            </div>
        </div>

        <!-- データ分析ダッシュボード -->
        <div id="analyticsContainer" class="hidden canva-card rounded-3xl p-8 mb-8 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">📊 学習分析ダッシュボード</h2>
                <button onclick="hideAnalytics()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition-all">
                    ← 戻る
                </button>
            </div>
            
            <!-- 統計サマリー -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-2xl text-center">
                    <div class="text-3xl font-bold" id="totalQuizzes">0</div>
                    <div class="text-sm opacity-90">総クイズ数</div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-2xl text-center">
                    <div class="text-3xl font-bold" id="averageScore">0%</div>
                    <div class="text-sm opacity-90">平均正答率</div>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-2xl text-center">
                    <div class="text-3xl font-bold" id="totalTime">0分</div>
                    <div class="text-sm opacity-90">総学習時間</div>
                </div>
                <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-2xl text-center">
                    <div class="text-3xl font-bold" id="streak">0日</div>
                    <div class="text-sm opacity-90">連続学習日数</div>
                </div>
            </div>
            
            <!-- チャート -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">📈 正答率の推移</h3>
                    <canvas id="scoreChart" width="400" height="200"></canvas>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">📊 カテゴリ別成績</h3>
                    <canvas id="categoryChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <!-- 詳細分析 -->
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">🎯 弱点分析</h3>
                <div id="weaknessAnalysis" class="space-y-4">
                    <!-- 弱点分析がここに表示されます -->
                </div>
            </div>
            
            <!-- 広告スペース2 -->
            <div class="ad-container mt-8">
                <div class="ad-label">おすすめ</div>
                <div class="bg-gradient-to-r from-green-500 to-teal-600 text-white p-4 rounded-lg">
                    <h3 class="font-bold mb-2">🚀 学習効率を最大化</h3>
                    <p class="text-sm">AI分析による個別学習プランで成績向上を実現</p>
                </div>
            </div>
        </div>

        <!-- 管理者画面 -->
        <div id="adminContainer" class="hidden canva-card rounded-3xl p-6 sm:p-8 mb-8 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">⚙️ 管理者画面</h2>
                <button onclick="hideAdminPanel()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition-all">
                    ← 戻る
                </button>
            </div>
            
            <!-- スプレッドシート読み込み -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">📊 スプレッドシートから問題を読み込み</h3>
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-blue-800 mb-2">📋 データ形式</h4>
                    <p class="text-blue-700 text-sm mb-3">スプレッドシートは以下の列構成で作成してください：</p>
                    <div class="bg-white p-3 rounded border text-xs font-mono">
                        A列: 問題文 | B列: タイプ(single/multiple/truefalse) | C列: 選択肢(カンマ区切り) | D列: 正解(カンマ区切り) | E列: カテゴリ | F列: 難易度 | G列: 解説
                    </div>
                    <p class="text-blue-600 text-sm mt-2">
                        ⚠️ スプレッドシートを「リンクを知っている全員が閲覧可能」に設定してください
                    </p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">📎 スプレッドシートURL</label>
                        <input type="url" id="spreadsheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..." 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="loadFromSpreadsheet()" class="canva-button text-white px-6 py-3 rounded-lg font-semibold shadow-lg">
                            📥 データを読み込む
                        </button>
                        <button onclick="refreshSpreadsheetData()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all">
                            🔄 データを更新
                        </button>
                        <button onclick="loadSampleData()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all">
                            🎯 サンプルデータを読み込む
                        </button>
                    </div>
                </div>
                
                <!-- 読み込み状況 -->
                <div id="loadingMessage" class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-600 mr-3"></div>
                        <span class="text-yellow-700">データを読み込み中...</span>
                    </div>
                </div>
                
                <!-- 検証結果 -->
                <div id="validationResults" class="hidden mt-4"></div>
            </div>
            
            <!-- ユーザー統計 -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">👥 ユーザー統計</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600" id="adminTotalUsers">0</div>
                        <div class="text-sm text-blue-600">総ユーザー数</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600" id="adminTodayLogins">0</div>
                        <div class="text-sm text-green-600">今日のログイン</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-purple-600" id="adminWeeklyLogins">0</div>
                        <div class="text-sm text-purple-600">今週のログイン</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-orange-600" id="adminPremiumUsers">0</div>
                        <div class="text-sm text-orange-600">プレミアムユーザー</div>
                    </div>
                </div>
                
                <!-- プラン別ユーザー数 -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-3">プラン別ユーザー数</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="text-lg font-bold text-blue-600" id="adminFreeUsers">0</div>
                            <div class="text-xs text-gray-600">無料プラン</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-purple-600" id="adminPremiumUsersDetail">0</div>
                            <div class="text-xs text-gray-600">プレミアムプラン</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-red-600" id="adminAdminUsers">0</div>
                            <div class="text-xs text-gray-600">管理者</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 現在のデータ状況 -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">📈 現在のデータ状況</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600" id="adminTotalQuestions">0</div>
                        <div class="text-sm text-blue-600">総問題数</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600" id="adminTotalCategories">0</div>
                        <div class="text-sm text-green-600">カテゴリ数</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-purple-600" id="adminLastUpdate">未更新</div>
                        <div class="text-sm text-purple-600">最終更新</div>
                    </div>
                </div>
            </div>
            
            <!-- カテゴリ別問題数 -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">📚 カテゴリ別問題数</h3>
                <div id="adminCategoryBreakdown" class="space-y-2">
                    <!-- カテゴリ別データがここに表示されます -->
                </div>
            </div>
            
            <!-- データ管理 -->
            <div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">🗂️ データ管理</h3>
                <div class="flex flex-wrap gap-3">
                    <button onclick="exportData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-all">
                        📤 データをエクスポート
                    </button>
                    <button onclick="clearAllData()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all">
                        🗑️ 全データを削除
                    </button>
                    <button onclick="resetToSample()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-all">
                        🔄 サンプルデータにリセット
                    </button>
                </div>
            </div>
        </div>

        <!-- 画像アップロードモーダル -->
        <div id="imageUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="canva-card rounded-3xl p-6 sm:p-8 max-w-md mx-4 bounce-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 flex items-center">
                        <span class="text-2xl mr-3">📷</span>
                        ヒーロー画像の変更
                    </h2>
                    <button onclick="closeImageUploadModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">画像URL</label>
                        <input type="url" id="heroImageUrl" placeholder="https://example.com/image.jpg" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">推奨サイズ: 200×150px または同比率</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="updateHeroImage()" class="canva-button text-white px-6 py-3 rounded-lg font-semibold w-full shadow-lg">
                            🖼️ 画像を設定
                        </button>
                        <button onclick="resetToDefaultImage()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold w-full shadow-lg transition-all">
                            🔄 デフォルトに戻す
                        </button>
                        <button onclick="closeImageUploadModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold w-full shadow-lg transition-all">
                            キャンセル
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- バッジ一覧モーダル -->
        <div id="badgeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="canva-card rounded-3xl p-6 sm:p-8 max-w-4xl mx-4 max-h-[80vh] overflow-y-auto bounce-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 flex items-center">
                        <span class="text-3xl mr-3">🏆</span>
                        バッジコレクション
                    </h2>
                    <button onclick="closeBadgeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                </div>
                
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-lg font-semibold text-gray-700">
                            獲得済み: <span id="earnedBadgeCount">0</span> / <span id="totalBadgeCount">15</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            コンプリート率: <span id="badgeCompletionRate">0%</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="badgeProgressBar" class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full h-2 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4" id="allBadgesContainer">
                    <!-- 全バッジがここに表示されます -->
                </div>
            </div>
        </div>

        <!-- プレミアムアップグレードモーダル -->
        <div id="upgradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="canva-card rounded-3xl p-8 max-w-md mx-4 bounce-in">
                <div class="text-center">
                    <div class="text-6xl mb-4">⭐</div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">プレミアムプランにアップグレード</h2>
                    <p class="text-gray-600 mb-6">中級・上級問題にアクセスして、さらなるスキルアップを！</p>
                    
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl p-6 mb-6 pulse-glow">
                        <div class="text-4xl font-bold mb-2">¥980</div>
                        <div class="text-lg">月額</div>
                    </div>
                    
                    <div class="text-left mb-6 space-y-2">
                        <div class="flex items-center">
                            <span class="text-green-500 mr-2">✓</span>
                            <span>全難易度の問題にアクセス</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-green-500 mr-2">✓</span>
                            <span>詳細な解説付き</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-green-500 mr-2">✓</span>
                            <span>高度な学習分析機能</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-green-500 mr-2">✓</span>
                            <span>広告非表示</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-green-500 mr-2">✓</span>
                            <span>優先サポート</span>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="upgradeToPremium()" class="canva-button text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg">
                            💳 今すぐアップグレード
                        </button>
                        <button onclick="closeUpgradeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg transition-all">
                            後で
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-4">※ デモ版では実際の課金は発生しません</p>
                </div>
            </div>
        </div>

        <!-- クイズ設定パネル（ホームから呼び出される） -->
        <div id="setupPanel" class="hidden canva-card rounded-3xl p-6 sm:p-8 mb-8 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800">⚙️ クイズ設定</h2>
                <button onclick="showHome()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition-all text-sm">
                    ← ホームに戻る
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- クイズ設定 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">⭐ 難易度選択</label>
                        <select id="difficultySelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="all">すべての難易度</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">選択中: <span id="difficultyCount">0</span>問</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">🔀 問題の順序</label>
                        <select id="shuffleMode" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="normal">順番通り</option>
                            <option value="shuffle">ランダム</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">⏱️ 制限時間（分）</label>
                        <select id="timeLimit" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="0">制限なし</option>
                            <option value="5">5分</option>
                            <option value="10">10分</option>
                            <option value="15">15分</option>
                            <option value="30">30分</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">📊 問題数</label>
                        <select id="questionLimit" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="all">すべて</option>
                            <option value="5">5問</option>
                            <option value="10">10問</option>
                            <option value="20">20問</option>
                            <option value="50">50問</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-8 text-center">
                    <button onclick="startQuiz()" class="canva-button text-white px-12 py-5 rounded-2xl font-bold text-xl shadow-2xl transform hover:scale-105">
                        🚀 クイズを開始する
                    </button>
                </div>
            </div>
        </div>



        <!-- クイズ画面 -->
        <div id="quizContainer" class="hidden">
            <!-- プログレスバーとタイマー -->
            <div class="canva-card rounded-3xl p-6 mb-6 fade-in">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-600">進捗</span>
                    <div class="flex items-center space-x-4">
                        <span id="progressText" class="text-sm font-medium text-gray-600" aria-live="polite">1 / 10</span>
                        <div id="timerDisplay" class="hidden flex items-center text-sm font-medium text-orange-600">
                            <span class="mr-1" aria-hidden="true">⏱️</span>
                            <span id="timeRemaining" aria-live="polite" aria-label="残り時間">10:00</span>
                        </div>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="10" aria-label="クイズ進捗">
                    <div id="progressBar" class="progress-bar h-3 rounded-full" style="width: 10%"></div>
                </div>
            </div>

            <!-- 問題カード -->
            <div class="quiz-card rounded-2xl p-8 text-white mb-6 slide-up">
                <div class="text-center">
                    <div id="questionNumber" class="text-lg font-medium mb-4 opacity-90">問題 1</div>
                    <h2 id="questionText" class="text-2xl font-bold mb-6 leading-relaxed">問題文がここに表示されます</h2>
                    <div class="flex justify-center space-x-3 mb-4">
                        <div id="questionCategory" class="inline-block bg-white bg-opacity-20 px-4 py-2 rounded-full text-sm font-medium">
                            一般知識
                        </div>
                        <div id="questionDifficulty" class="inline-block bg-white bg-opacity-20 px-4 py-2 rounded-full text-sm font-medium">
                            初級
                        </div>
                        <div id="questionType" class="inline-block bg-white bg-opacity-20 px-4 py-2 rounded-full text-sm font-medium">
                            択一選択
                        </div>
                    </div>
                </div>
            </div>

            <!-- 広告スペース4（問題間に表示、無料プランのみ） -->
            <div id="adSpace4" class="ad-container mb-6">
                <div class="ad-label">広告</div>
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-lg">
                    <h3 class="font-bold mb-2">🎯 集中力UP！</h3>
                    <p class="text-sm">プレミアムプランで広告なしの快適学習環境を体験</p>
                </div>
            </div>

            <!-- 選択肢 -->
            <div id="optionsContainer" class="space-y-4 mb-8">
                <!-- 選択肢がここに動的に生成されます -->
            </div>

            <!-- 操作ボタン -->
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
                <div class="flex space-x-3 w-full sm:w-auto">
                    <button onclick="showHome()" class="flex-1 sm:flex-none bg-green-500 hover:bg-green-600 text-white px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-semibold transition-all shadow-lg text-sm sm:text-base">
                        🏠 ホーム
                    </button>
                    <button id="prevButton" onclick="previousQuestion()" 
                            class="flex-1 sm:flex-none bg-gray-400 hover:bg-gray-500 text-white px-4 sm:px-8 py-3 sm:py-4 rounded-xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg text-sm sm:text-base">
                        ← 前の問題
                    </button>
                </div>
                <button id="nextButton" onclick="nextQuestion()" 
                        class="w-full sm:w-auto canva-button text-white px-6 sm:px-8 py-3 sm:py-4 rounded-xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg text-sm sm:text-base">
                    次の問題 →
                </button>
            </div>
        </div>

        <!-- 結果画面 -->
        <div id="resultContainer" class="hidden">
            <div class="canva-card rounded-3xl p-8 text-center mb-6 fade-in">
                <div class="text-6xl mb-4">🎉</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">クイズ完了！</h2>
                <div class="text-6xl font-bold text-purple-600 mb-2 bounce-in" id="finalScore">8/10</div>
                <p class="text-gray-600 mb-6">お疲れさまでした！</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="correctCount">8</div>
                        <div class="text-sm text-green-600">正解</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-red-600" id="incorrectCount">2</div>
                        <div class="text-sm text-red-600">不正解</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="accuracyRate">80%</div>
                        <div class="text-sm text-blue-600">正答率</div>
                    </div>
                </div>
                <!-- 称号表示 -->
                <div id="achievementSection" class="hidden mb-8">
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-3xl p-6 text-center text-white shadow-2xl bounce-in">
                        <div class="text-4xl mb-3">🏆</div>
                        <h3 class="text-2xl font-bold mb-2">称号獲得！</h3>
                        <div id="achievementTitle" class="text-3xl font-bold mb-2">マーケティング道場 初級マスター</div>
                        <p id="achievementDescription" class="text-lg opacity-90">初級レベルの問題を全問正解しました！</p>
                    </div>
                </div>
                
                <!-- 広告スペース5（結果画面、無料プランのみ） -->
                <div id="adSpace5" class="ad-container mb-6">
                    <div class="ad-label">おすすめ</div>
                    <div class="bg-gradient-to-r from-pink-500 to-rose-600 text-white p-4 rounded-lg">
                        <h3 class="font-bold mb-2">🏆 さらなる高みへ</h3>
                        <p class="text-sm">プレミアムプランで上級問題に挑戦し、真のエキスパートを目指そう</p>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button onclick="showHome()" 
                            class="bg-green-500 hover:bg-green-600 text-white px-6 sm:px-8 py-3 sm:py-4 rounded-2xl font-semibold shadow-lg text-sm sm:text-base">
                        🏠 ホームに戻る
                    </button>
                    <button onclick="showDetailedResults()" 
                            class="canva-button text-white px-6 sm:px-8 py-3 sm:py-4 rounded-2xl font-semibold shadow-lg text-sm sm:text-base">
                        📊 詳細結果を見る
                    </button>
                    <button onclick="restartQuiz()" 
                            class="canva-button text-white px-6 sm:px-8 py-3 sm:py-4 rounded-2xl font-semibold shadow-lg text-sm sm:text-base">
                        🔄 もう一度挑戦
                    </button>
                </div>
            </div>
            
            <!-- 詳細結果 -->
            <div id="detailedResults" class="hidden canva-card rounded-3xl p-6 fade-in">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">📊 問題別詳細結果</h3>
                <div id="detailedResultsList" class="space-y-4">
                    <!-- 詳細結果がここに動的に生成されます -->
                </div>
                <div class="text-center mt-6">
                    <button onclick="hideDetailedResults()" 
                            class="bg-gray-400 hover:bg-gray-500 text-white px-8 py-4 rounded-2xl font-semibold transition-all shadow-lg">
                        ← 戻る
                    </button>
                </div>
            </div>
        </div>
        
        <!-- SEO用フッター -->
        <footer class="mt-16 bg-gray-800 text-white py-8">
            <div class="container mx-auto px-4 max-w-4xl">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div>
                        <h4 class="text-lg font-bold mb-4">ゆるマーケ道場について</h4>
                        <p class="text-gray-300 text-sm">
                            マーケティングスキルを楽しく学べるクイズアプリです。SEO、広告運用、AI活用など実践的な問題で知識を深めることができます。
                        </p>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold mb-4">学習カテゴリ</h4>
                        <ul class="text-gray-300 text-sm space-y-2">
                            <li><a href="#" class="hover:text-white">SEO（検索エンジン最適化）</a></li>
                            <li><a href="#" class="hover:text-white">デジタル広告運用</a></li>
                            <li><a href="#" class="hover:text-white">AI・ChatGPT活用</a></li>
                            <li><a href="#" class="hover:text-white">コンテンツマーケティング</a></li>
                            <li><a href="#" class="hover:text-white">ECサイト運営</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold mb-4">プラン</h4>
                        <ul class="text-gray-300 text-sm space-y-2">
                            <li>無料プラン - 初級問題にアクセス</li>
                            <li>プレミアムプラン - 全問題＋詳細解説</li>
                        </ul>
                        <div class="mt-4">
                            <p class="text-xs text-gray-400">
                                © 2024 ゆるマーケ道場. All rights reserved.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        let questions = [];
        let originalQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let selectedAnswers = new Set();
        let timerInterval = null;
        let timeRemaining = 0;
        let quizStartTime = null;
        let quizHistory = JSON.parse(localStorage.getItem('quizHistory') || '[]');
        let scoreChart = null;
        let categoryChart = null;
        let selectedCategory = 'all';

        // 文字の正規化関数（○×の文字化けを防ぐ）
        function normalizeText(text) {
            return text.trim()
                .replace(/○/g, '○')  // 全角○に統一
                .replace(/×/g, '×')  // 全角×に統一
                .replace(/◯/g, '○')  // ◯を○に変換
                .replace(/✕/g, '×')  // ✕を×に変換
                .replace(/\s+/g, ' '); // 複数の空白を1つに
        }

        // ユーザー管理
        let currentUser = null;
        
        // ログイン状態の永続化
        function saveUserSession(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
        }
        
        function loadUserSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    return JSON.parse(savedUser);
                } catch (error) {
                    console.error('ユーザーセッションの復元に失敗:', error);
                    localStorage.removeItem('currentUser');
                }
            }
            return null;
        }
        
        function clearUserSession() {
            localStorage.removeItem('currentUser');
        }
        
        // デモ用ユーザーデータ
        const demoUsers = {
            'demo@free.com': { name: 'フリーユーザー', plan: 'free', password: 'password123' },
            'demo@premium.com': { name: 'プレミアムユーザー', plan: 'premium', password: 'password123' },
            'admin@demo.com': { name: '管理者', plan: 'admin', password: 'admin123' }
        };

        // ユーザー統計管理
        function getUserStats() {
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const loginHistory = JSON.parse(localStorage.getItem('loginHistory') || '[]');
            
            // 今日のログイン数
            const today = new Date().toDateString();
            const todayLogins = loginHistory.filter(login => 
                new Date(login.timestamp).toDateString() === today
            ).length;
            
            // 今週のログイン数
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weeklyLogins = loginHistory.filter(login => 
                new Date(login.timestamp) >= weekAgo
            ).length;
            
            // プラン別ユーザー数
            const planStats = {
                free: registeredUsers.filter(user => user.plan === 'free').length,
                premium: registeredUsers.filter(user => user.plan === 'premium').length,
                admin: registeredUsers.filter(user => user.plan === 'admin').length
            };
            
            return {
                totalUsers: registeredUsers.length + Object.keys(demoUsers).length,
                registeredUsers: registeredUsers.length,
                demoUsers: Object.keys(demoUsers).length,
                todayLogins,
                weeklyLogins,
                planStats
            };
        }

        function trackLogin(email, plan) {
            const loginHistory = JSON.parse(localStorage.getItem('loginHistory') || '[]');
            loginHistory.push({
                email,
                plan,
                timestamp: new Date().toISOString()
            });
            
            // 最新100件のみ保持
            if (loginHistory.length > 100) {
                loginHistory.splice(0, loginHistory.length - 100);
            }
            
            localStorage.setItem('loginHistory', JSON.stringify(loginHistory));
        }

        // サンプルデータ
        const sampleQuestions = [
            {
                question: "SEOとは何の略称ですか？",
                type: "single",
                options: ["Search Engine Optimization", "Social Engine Optimization", "System Engine Operation", "Site Engine Organization"],
                correct: ["Search Engine Optimization"],
                category: "SEO",
                difficulty: "初級",
                explanation: "SEOは「Search Engine Optimization（検索エンジン最適化）」の略称です。検索エンジンでの表示順位を向上させる施策のことを指します。"
            },
            {
                question: "HTMLの正式名称は何ですか？",
                type: "single",
                options: ["HyperText Markup Language", "High Tech Modern Language", "Home Tool Markup Language", "Hyper Transfer Markup Language"],
                correct: ["HyperText Markup Language"],
                category: "HTML",
                difficulty: "初級",
                explanation: "HTMLは「HyperText Markup Language」の略称です。Webページの構造を記述するためのマークアップ言語です。"
            },
            {
                question: "Google広告の課金方式として正しいものはどれですか？（複数選択可）",
                type: "multiple",
                options: ["CPC（クリック課金）", "CPM（インプレッション課金）", "CPA（成果課金）", "CPL（リード課金）"],
                correct: ["CPC（クリック課金）", "CPM（インプレッション課金）"],
                category: "広告",
                difficulty: "中級",
                explanation: "Google広告では主にCPC（クリック課金）とCPM（インプレッション課金）が使用されます。CPAやCPLは他の広告プラットフォームでよく使われる課金方式です。"
            },
            {
                question: "CSSでテキストの色を赤にするプロパティは何ですか？",
                type: "single",
                options: ["color: red;", "text-color: red;", "font-color: red;", "background: red;"],
                correct: ["color: red;"],
                category: "CSS",
                difficulty: "初級",
                explanation: "CSSでテキストの色を指定するには「color」プロパティを使用します。「color: red;」でテキストが赤色になります。"
            },
            {
                question: "フィッシング詐欺とは偽のWebサイトで個人情報を盗む手法である",
                type: "truefalse",
                options: ["○", "×"],
                correct: ["○"],
                category: "リテラシー",
                difficulty: "初級",
                explanation: "フィッシング詐欺は、正規のWebサイトを装った偽サイトでユーザーの個人情報（ID、パスワード、クレジットカード情報など）を盗む詐欺手法です。"
            },
            {
                question: "WordPressで記事を投稿する際の基本的な投稿タイプはどれですか？",
                type: "single",
                options: ["Post", "Page", "Media", "Comment"],
                correct: ["Post"],
                category: "WordPress",
                difficulty: "初級",
                explanation: "WordPressでは「Post（投稿）」が基本的な記事投稿タイプです。Pageは固定ページ、Mediaはメディアファイル、Commentはコメント機能です。"
            },
            {
                question: "メールマーケティングで重要な指標はどれですか？（複数選択可）",
                type: "multiple",
                options: ["開封率", "クリック率", "配信数", "解除率"],
                correct: ["開封率", "クリック率", "解除率"],
                category: "メール",
                difficulty: "中級",
                explanation: "メールマーケティングでは開封率（メールが開かれた割合）、クリック率（リンクがクリックされた割合）、解除率（配信停止された割合）が重要な指標です。配信数は指標というより実績値です。"
            },
            {
                question: "コンテンツマーケティングの主な目的は何ですか？",
                type: "single",
                options: ["価値のある情報提供で顧客との関係構築", "商品の直接販売", "競合他社の分析", "SEO対策のみ"],
                correct: ["価値のある情報提供で顧客との関係構築"],
                category: "コンテンツ",
                difficulty: "中級",
                explanation: "コンテンツマーケティングは、価値のある情報を継続的に提供することで顧客との信頼関係を構築し、最終的にビジネス成果につなげる手法です。"
            },
            {
                question: "ECサイトでのコンバージョン率を向上させる施策はどれですか？（複数選択可）",
                type: "multiple",
                options: ["商品画像の最適化", "決済方法の多様化", "レビュー機能の充実", "サイトの表示速度向上"],
                correct: ["商品画像の最適化", "決済方法の多様化", "レビュー機能の充実", "サイトの表示速度向上"],
                category: "EC",
                difficulty: "上級",
                explanation: "ECサイトのコンバージョン率向上には、商品画像の最適化、決済方法の多様化、レビュー機能の充実、サイトの表示速度向上など、ユーザー体験を向上させる全ての施策が有効です。"
            },
            {
                question: "ChatGPTなどの生成AIの特徴として正しいものはどれですか？",
                type: "single",
                options: ["常に正確な情報を提供する", "学習データに基づいて応答を生成する", "インターネットにリアルタイムでアクセスできる", "感情を持って判断する"],
                correct: ["学習データに基づいて応答を生成する"],
                category: "AI",
                difficulty: "中級",
                explanation: "生成AIは学習データに基づいて応答を生成します。常に正確とは限らず、リアルタイムのインターネットアクセスや感情を持った判断はできません。"
            }
        ];

        // アニメーション効果
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }

        function createParticles(element) {
            const rect = element.getBoundingClientRect();
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = (rect.left + rect.width / 2) + 'px';
                particle.style.top = (rect.top + rect.height / 2) + 'px';
                particle.style.animationDelay = (i * 0.1) + 's';
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    particle.remove();
                }, 2000);
            }
        }

        // 広告表示制御
        function toggleAds() {
            const adElements = document.querySelectorAll('[id^="adSpace"], [id^="homeAdSpace"]');
            adElements.forEach(ad => {
                if (currentUser && currentUser.plan === 'premium') {
                    ad.style.display = 'none';
                } else {
                    ad.style.display = 'block';
                }
            });
        }

        // データ分析機能
        function saveQuizResult(result) {
            const quizData = {
                date: new Date().toISOString(),
                score: result.correctCount,
                total: result.totalQuestions,
                accuracy: result.accuracy,
                category: selectedCategory,
                difficulty: document.getElementById('difficultySelect').value,
                timeSpent: result.timeSpent,
                questions: result.questions
            };
            
            quizHistory.push(quizData);
            localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
            
            // Phase 2: ゲーミフィケーション処理
            const xpGained = calculateXP(result.correctCount, result.totalQuestions, quizData.difficulty);
            const leveledUp = updateUserLevel(xpGained);
            const newBadges = checkAndAwardBadges(quizData);
            updateDailyGoals(quizData, xpGained);
            
            // XP獲得通知
            if (xpGained > 0) {
                showXPNotification(xpGained, leveledUp);
            }
        }
        
        function showXPNotification(xp, leveledUp) {
            if (leveledUp) return; // レベルアップ通知が優先
            
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-green-400 to-blue-500 text-white p-4 rounded-xl shadow-lg z-50 fade-in';
            notification.innerHTML = `
                <div class="flex items-center">
                    <div class="text-2xl mr-3">⭐</div>
                    <div>
                        <div class="font-bold">+${xp} XP 獲得！</div>
                        <div class="text-sm opacity-90">よくできました！</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showAnalytics() {
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('analyticsContainer').classList.remove('hidden');
            
            updateAnalyticsDashboard();
        }

        function hideAnalytics() {
            document.getElementById('analyticsContainer').classList.add('hidden');
            document.getElementById('setupPanel').classList.remove('hidden');
        }

        function updateAnalyticsDashboard() {
            if (quizHistory.length === 0) {
                document.getElementById('totalQuizzes').textContent = '0';
                document.getElementById('averageScore').textContent = '0%';
                document.getElementById('totalTime').textContent = '0分';
                document.getElementById('streak').textContent = '0日';
                return;
            }

            // 基本統計
            const totalQuizzes = quizHistory.length;
            const averageScore = Math.round(
                quizHistory.reduce((sum, quiz) => sum + quiz.accuracy, 0) / totalQuizzes
            );
            const totalTime = Math.round(
                quizHistory.reduce((sum, quiz) => sum + (quiz.timeSpent || 0), 0) / 60
            );
            
            // 連続学習日数計算
            const streak = calculateStreak();

            document.getElementById('totalQuizzes').textContent = totalQuizzes;
            document.getElementById('averageScore').textContent = averageScore + '%';
            document.getElementById('totalTime').textContent = totalTime + '分';
            document.getElementById('streak').textContent = streak + '日';

            // チャート更新
            updateScoreChart();
            updateCategoryChart();
            updateWeaknessAnalysis();
        }

        function calculateStreak() {
            if (quizHistory.length === 0) return 0;
            
            const today = new Date();
            const dates = quizHistory.map(quiz => new Date(quiz.date).toDateString());
            const uniqueDates = [...new Set(dates)].sort((a, b) => new Date(b) - new Date(a));
            
            let streak = 0;
            let currentDate = today;
            
            for (const dateStr of uniqueDates) {
                const date = new Date(dateStr);
                const diffDays = Math.floor((currentDate - date) / (1000 * 60 * 60 * 24));
                
                if (diffDays === streak) {
                    streak++;
                    currentDate = date;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function updateScoreChart() {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            
            if (scoreChart) {
                scoreChart.destroy();
            }
            
            const last10Quizzes = quizHistory.slice(-10);
            const labels = last10Quizzes.map((_, index) => `${index + 1}回目`);
            const data = last10Quizzes.map(quiz => quiz.accuracy);
            
            scoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '正答率 (%)',
                        data: data,
                        borderColor: '#00c4cc',
                        backgroundColor: 'rgba(0, 196, 204, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const categoryStats = {};
            quizHistory.forEach(quiz => {
                const category = quiz.category || 'その他';
                if (!categoryStats[category]) {
                    categoryStats[category] = { total: 0, correct: 0 };
                }
                categoryStats[category].total += quiz.total;
                categoryStats[category].correct += quiz.score;
            });
            
            const labels = Object.keys(categoryStats);
            const data = labels.map(category => 
                Math.round((categoryStats[category].correct / categoryStats[category].total) * 100)
            );
            
            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '正答率 (%)',
                        data: data,
                        backgroundColor: [
                            '#00c4cc',
                            '#7b68ee',
                            '#ff6b9d',
                            '#00d4aa',
                            '#ffa500'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function updateWeaknessAnalysis() {
            const container = document.getElementById('weaknessAnalysis');
            
            if (quizHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500">データが不足しています。もっとクイズに挑戦してください！</p>';
                return;
            }
            
            // カテゴリ別の弱点分析
            const categoryStats = {};
            quizHistory.forEach(quiz => {
                const category = quiz.category || 'その他';
                if (!categoryStats[category]) {
                    categoryStats[category] = { total: 0, correct: 0 };
                }
                categoryStats[category].total += quiz.total;
                categoryStats[category].correct += quiz.score;
            });
            
            const weakCategories = Object.entries(categoryStats)
                .map(([category, stats]) => ({
                    category,
                    accuracy: (stats.correct / stats.total) * 100,
                    total: stats.total
                }))
                .filter(item => item.accuracy < 70)
                .sort((a, b) => a.accuracy - b.accuracy);
            
            let html = '';
            if (weakCategories.length === 0) {
                html = '<div class="text-green-600">🎉 すべてのカテゴリで良好な成績です！</div>';
            } else {
                html = '<div class="space-y-3">';
                weakCategories.forEach(item => {
                    html += `
                        <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border-l-4 border-red-400">
                            <div>
                                <span class="font-medium text-red-800">${item.category}</span>
                                <span class="text-sm text-red-600 ml-2">(${item.total}問中)</span>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-red-600">${Math.round(item.accuracy)}%</div>
                                <div class="text-xs text-red-500">要復習</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        // ログイン機能
        function showLogin() {
            document.getElementById('registerContainer').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
        }

        function showRegister() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('registerContainer').classList.remove('hidden');
        }

        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('メールアドレスとパスワードを入力してください');
                return;
            }
            
            // デモ用認証
            if (demoUsers[email] && demoUsers[email].password === password) {
                currentUser = {
                    email: email,
                    name: demoUsers[email].name,
                    plan: demoUsers[email].plan,
                    loginMethod: 'email'
                };
                
                // ログイン状態を保存
                saveUserSession(currentUser);
                
                // ログイン履歴を記録
                trackLogin(email, currentUser.plan);
                
                showMainApp();
                
                // Google Analytics イベント
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'login', {
                        method: 'email',
                        user_plan: currentUser.plan
                    });
                }
            } else {
                alert('メールアドレスまたはパスワードが間違っています');
            }
        }
        
        // Googleログイン機能
        function googleLogin() {
            // デモ版では簡易的なGoogleログインをシミュレート
            if (typeof google !== 'undefined' && google.accounts) {
                // 実際のGoogle Sign-In実装
                google.accounts.id.initialize({
                    client_id: 'YOUR_GOOGLE_CLIENT_ID', // 実際のクライアントIDに置き換え
                    callback: handleGoogleSignIn
                });
                
                google.accounts.id.prompt();
            } else {
                // デモ版のシミュレート
                const mockGoogleUser = {
                    email: 'demo.google@gmail.com',
                    name: 'Google ユーザー',
                    picture: 'https://via.placeholder.com/40',
                    plan: 'free'
                };
                
                currentUser = {
                    ...mockGoogleUser,
                    loginMethod: 'google'
                };
                
                // ログイン状態を保存
                saveUserSession(currentUser);
                
                // ログイン履歴を記録
                trackLogin(mockGoogleUser.email, mockGoogleUser.plan);
                
                alert('Googleアカウントでログインしました！\n（デモ版のため、実際のGoogleアカウントは使用されません）');
                showMainApp();
                
                // Google Analytics イベント
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'login', {
                        method: 'google',
                        user_plan: currentUser.plan
                    });
                }
            }
        }
        
        function handleGoogleSignIn(response) {
            // JWTトークンをデコード（実際の実装では適切なライブラリを使用）
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            
            currentUser = {
                email: payload.email,
                name: payload.name,
                picture: payload.picture,
                plan: 'free', // 新規Googleユーザーは無料プランから開始
                loginMethod: 'google'
            };
            
            // ログイン状態を保存
            saveUserSession(currentUser);
            
            // ログイン履歴を記録
            trackLogin(payload.email, 'free');
            
            showMainApp();
            
            // Google Analytics イベント
            if (typeof gtag !== 'undefined') {
                gtag('event', 'login', {
                    method: 'google',
                    user_plan: 'free'
                });
            }
        }

        function register() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                alert('すべての項目を入力してください');
                return;
            }
            
            // 簡単なバリデーション
            if (!email.includes('@')) {
                alert('有効なメールアドレスを入力してください');
                return;
            }
            
            if (password.length < 6) {
                alert('パスワードは6文字以上で入力してください');
                return;
            }
            
            // 新規ユーザー作成（デモ版）
            currentUser = {
                email: email,
                name: name,
                plan: 'free',
                loginMethod: 'email'
            };
            
            // ログイン状態を保存
            saveUserSession(currentUser);
            
            // 登録ユーザーをローカルストレージに保存
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            registeredUsers.push(currentUser);
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            
            // ログイン履歴を記録
            trackLogin(email, 'free');
            
            alert('登録が完了しました！');
            showMainApp();
            
            // Google Analytics イベント
            if (typeof gtag !== 'undefined') {
                gtag('event', 'sign_up', {
                    method: 'email'
                });
            }
        }

        function loginAsGuest() {
            currentUser = {
                email: 'guest@example.com',
                name: 'ゲストユーザー',
                plan: 'free',
                loginMethod: 'guest'
            };
            
            // ログイン状態を保存
            saveUserSession(currentUser);
            
            // ログイン履歴を記録
            trackLogin('guest@example.com', 'free');
            
            showMainApp();
            
            // Google Analytics イベント
            if (typeof gtag !== 'undefined') {
                gtag('event', 'login', {
                    method: 'guest'
                });
            }
        }

        function logout() {
            currentUser = null;
            
            // ログイン状態をクリア
            clearUserSession();
            
            document.getElementById('mainHeader').classList.add('hidden');
            document.getElementById('homeContainer').classList.add('hidden');
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('analyticsContainer').classList.add('hidden');
            document.getElementById('adminContainer').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            
            // フォームをリセット
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            // Google Analytics イベント
            if (typeof gtag !== 'undefined') {
                gtag('event', 'logout');
            }
        }

        function showMainApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('registerContainer').classList.add('hidden');
            document.getElementById('mainHeader').classList.remove('hidden');
            
            // ユーザー情報を表示
            const userNameDisplay = document.getElementById('userNameDisplay');
            
            // Googleログインユーザーの場合はプロフィール画像も表示
            if (currentUser.loginMethod === 'google' && currentUser.picture) {
                userNameDisplay.innerHTML = `
                    <div class="flex items-center">
                        <img src="${currentUser.picture}" alt="プロフィール" class="w-6 h-6 rounded-full mr-2">
                        <span>${currentUser.name}</span>
                    </div>
                `;
            } else {
                userNameDisplay.textContent = currentUser.name;
            }
            
            const planDisplay = document.getElementById('userPlanDisplay');
            const upgradeButton = document.getElementById('upgradeButton');
            const adminButton = document.getElementById('adminButton');
            const changeImageButton = document.getElementById('changeImageButton');
            
            if (currentUser.plan === 'admin') {
                planDisplay.textContent = '管理者';
                planDisplay.className = 'text-xs sm:text-sm px-2 sm:px-3 py-1 rounded-full bg-gradient-to-r from-red-500 to-orange-500 text-white';
                upgradeButton.classList.add('hidden');
                if (adminButton) adminButton.classList.remove('hidden');
                if (changeImageButton) changeImageButton.classList.remove('hidden');
            } else if (currentUser.plan === 'premium') {
                planDisplay.textContent = 'プレミアムプラン';
                planDisplay.className = 'text-xs sm:text-sm px-2 sm:px-3 py-1 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white';
                upgradeButton.classList.add('hidden');
                if (adminButton) adminButton.classList.add('hidden');
                if (changeImageButton) changeImageButton.classList.add('hidden');
            } else {
                planDisplay.textContent = '無料プラン';
                planDisplay.className = 'text-xs sm:text-sm px-2 sm:px-3 py-1 rounded-full bg-blue-100 text-blue-600';
                upgradeButton.classList.remove('hidden');
                if (adminButton) adminButton.classList.add('hidden');
                if (changeImageButton) changeImageButton.classList.add('hidden');
            }
            
            // 保存されたデータを復元、なければサンプルデータを読み込み
            loadStoredDataOrSample();
            
            // ホーム画面を表示
            showHome();
            
            // 広告表示制御
            toggleAds();
            
            // カスタム画像の復元
            loadCustomHeroImage();
        }

        function loadStoredDataOrSample() {
            const storedQuestions = localStorage.getItem('quizQuestions');
            if (storedQuestions) {
                try {
                    originalQuestions = JSON.parse(storedQuestions);
                    questions = [...originalQuestions];
                    console.log('保存されたデータを復元しました:', originalQuestions.length + '問');
                    
                    // データ復元後に全画面を更新
                    setTimeout(() => {
                        updateCategoryGrid();
                        updateHomeStats();
                        updateRecentHistory();
                        updateDifficultyOptions(selectedCategory);
                    }, 100);
                } catch (error) {
                    console.error('保存されたデータの復元に失敗:', error);
                    loadSampleData();
                }
            } else {
                loadSampleData();
            }
        }

        function showHome() {
            // 全ての画面を非表示
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('analyticsContainer').classList.add('hidden');
            document.getElementById('detailedResults').classList.add('hidden');
            document.getElementById('adminContainer').classList.add('hidden');
            
            // ホーム画面を表示
            document.getElementById('homeContainer').classList.remove('hidden');
            
            // ホーム画面のデータを更新
            updateHomeStats();
            updateCategoryGrid();
            updateRecentHistory();
        }

        // 管理者画面機能
        function showAdminPanel() {
            // 全ての画面を非表示
            document.getElementById('homeContainer').classList.add('hidden');
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('analyticsContainer').classList.add('hidden');
            document.getElementById('detailedResults').classList.add('hidden');
            
            // 管理者画面を表示
            document.getElementById('adminContainer').classList.remove('hidden');
            
            // 管理者画面のデータを更新
            updateAdminDashboard();
        }

        function hideAdminPanel() {
            document.getElementById('adminContainer').classList.add('hidden');
            showHome();
        }

        function updateAdminDashboard() {
            // ユーザー統計
            const userStats = getUserStats();
            document.getElementById('adminTotalUsers').textContent = userStats.totalUsers;
            document.getElementById('adminTodayLogins').textContent = userStats.todayLogins;
            document.getElementById('adminWeeklyLogins').textContent = userStats.weeklyLogins;
            document.getElementById('adminPremiumUsers').textContent = userStats.planStats.premium;
            document.getElementById('adminFreeUsers').textContent = userStats.planStats.free;
            document.getElementById('adminPremiumUsersDetail').textContent = userStats.planStats.premium;
            document.getElementById('adminAdminUsers').textContent = userStats.planStats.admin;
            
            // 基本統計
            const totalQuestions = originalQuestions.length;
            const categories = [...new Set(originalQuestions.map(q => q.category || '未分類'))];
            const lastUpdate = localStorage.getItem('lastDataUpdate') || '未更新';
            
            document.getElementById('adminTotalQuestions').textContent = totalQuestions;
            document.getElementById('adminTotalCategories').textContent = categories.length;
            document.getElementById('adminLastUpdate').textContent = lastUpdate;
            
            // 保存されたスプレッドシートURLを復元
            const savedUrl = localStorage.getItem('spreadsheetUrl');
            if (savedUrl) {
                document.getElementById('spreadsheetUrl').value = savedUrl;
            }
            
            // カテゴリ別問題数
            updateAdminCategoryBreakdown();
        }

        function updateAdminCategoryBreakdown() {
            const container = document.getElementById('adminCategoryBreakdown');
            container.innerHTML = '';
            
            if (originalQuestions.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">データがありません</div>';
                return;
            }
            
            const categoryStats = {};
            originalQuestions.forEach(q => {
                const category = q.category || '未分類';
                const difficulty = q.difficulty || '未設定';
                
                if (!categoryStats[category]) {
                    categoryStats[category] = { total: 0, difficulties: {} };
                }
                categoryStats[category].total++;
                
                if (!categoryStats[category].difficulties[difficulty]) {
                    categoryStats[category].difficulties[difficulty] = 0;
                }
                categoryStats[category].difficulties[difficulty]++;
            });
            
            Object.entries(categoryStats).forEach(([category, stats]) => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-gray-50 p-4 rounded-lg border';
                
                const difficultyBreakdown = Object.entries(stats.difficulties)
                    .map(([diff, count]) => `${diff}: ${count}問`)
                    .join(', ');
                
                categoryCard.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-medium text-gray-800">${category}</span>
                            <div class="text-sm text-gray-600 mt-1">${difficultyBreakdown}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-blue-600">${stats.total}</div>
                            <div class="text-xs text-gray-500">問</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(categoryCard);
            });
        }

        function exportData() {
            if (originalQuestions.length === 0) {
                alert('エクスポートするデータがありません');
                return;
            }
            
            const csvContent = convertToCSV(originalQuestions);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `quiz_data_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function convertToCSV(questions) {
            const headers = ['問題文', 'タイプ', '選択肢', '正解', 'カテゴリ', '難易度', '解説'];
            const csvRows = [headers.join(',')];
            
            questions.forEach(q => {
                const row = [
                    `"${q.question.replace(/"/g, '""')}"`,
                    q.type,
                    `"${q.options.join(',')}"`,
                    `"${q.correct.join(',')}"`,
                    q.category || '未分類',
                    q.difficulty || '未設定',
                    `"${(q.explanation || '').replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }

        function clearAllData() {
            if (confirm('すべての問題データを削除しますか？この操作は取り消せません。')) {
                originalQuestions = [];
                questions = [];
                localStorage.removeItem('lastDataUpdate');
                localStorage.removeItem('quizQuestions');
                localStorage.removeItem('spreadsheetUrl');
                
                updateAdminDashboard();
                
                // ホーム画面が表示されている場合は更新
                if (!document.getElementById('homeContainer').classList.contains('hidden')) {
                    updateCategoryGrid();
                    updateHomeStats();
                    updateRecentHistory();
                }
                
                alert('すべてのデータを削除しました');
            }
        }

        function resetToSample() {
            if (confirm('サンプルデータにリセットしますか？現在のデータは失われます。')) {
                loadSampleData();
                updateAdminDashboard();
                alert('サンプルデータにリセットしました');
            }
        }

        function updateHomeStats() {
            // Phase 2: ゲーミフィケーション要素の更新
            updateLevelDisplay();
            updateDailyGoalsDisplay();
            updateRecentBadges();
            
            if (quizHistory.length === 0) {
                document.getElementById('homeTotalQuizzes').textContent = '0';
                document.getElementById('homeAverageScore').textContent = '0%';
                document.getElementById('homeStreak').textContent = '0日';
                document.getElementById('homeBestStreak').textContent = '0';
                document.getElementById('homeLevel').textContent = 'Lv.1';
                return;
            }

            const totalQuizzes = quizHistory.length;
            const averageScore = Math.round(
                quizHistory.reduce((sum, quiz) => sum + quiz.accuracy, 0) / totalQuizzes
            );
            const streak = learningStreak.current;
            const bestStreak = learningStreak.best;

            document.getElementById('homeTotalQuizzes').textContent = totalQuizzes;
            document.getElementById('homeAverageScore').textContent = averageScore + '%';
            document.getElementById('homeStreak').textContent = streak + '日';
            document.getElementById('homeBestStreak').textContent = bestStreak;
            document.getElementById('homeLevel').textContent = `Lv.${userLevel.level}`;
        }
        
        function updateLevelDisplay() {
            document.getElementById('userLevelDisplay').textContent = `Lv.${userLevel.level}`;
            document.getElementById('totalXPDisplay').textContent = userLevel.totalXP.toLocaleString();
            
            // 次のレベルまでのXP計算
            const nextLevelXP = levelThresholds[userLevel.level] || levelThresholds[levelThresholds.length - 1];
            const currentLevelXP = levelThresholds[userLevel.level - 1] || 0;
            const currentXP = userLevel.totalXP - currentLevelXP;
            const xpToNext = nextLevelXP - userLevel.totalXP;
            
            document.getElementById('userXPDisplay').textContent = `${currentXP.toLocaleString()} / ${(nextLevelXP - currentLevelXP).toLocaleString()} XP`;
            
            // プログレスバー更新
            const progressPercent = (currentXP / (nextLevelXP - currentLevelXP)) * 100;
            document.getElementById('xpProgressBar').style.width = `${Math.min(progressPercent, 100)}%`;
        }
        
        function updateDailyGoalsDisplay() {
            const today = new Date().toDateString();
            initializeDailyGoals();
            
            const todayGoals = dailyGoals[today];
            const container = document.getElementById('dailyGoalsContainer');
            
            container.innerHTML = `
                <div class="text-center">
                    <div class="text-2xl mb-2">📝</div>
                    <div class="text-sm text-gray-600 mb-1">クイズ完了</div>
                    <div class="text-lg font-bold text-blue-600">${todayGoals.progress.quizzesCompleted} / ${todayGoals.goals.quizzes}</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div class="bg-blue-500 rounded-full h-2 transition-all" style="width: ${Math.min((todayGoals.progress.quizzesCompleted / todayGoals.goals.quizzes) * 100, 100)}%"></div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-2xl mb-2">❓</div>
                    <div class="text-sm text-gray-600 mb-1">問題数</div>
                    <div class="text-lg font-bold text-green-600">${todayGoals.progress.questionsAnswered} / ${todayGoals.goals.questions}</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div class="bg-green-500 rounded-full h-2 transition-all" style="width: ${Math.min((todayGoals.progress.questionsAnswered / todayGoals.goals.questions) * 100, 100)}%"></div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-2xl mb-2">⭐</div>
                    <div class="text-sm text-gray-600 mb-1">XP獲得</div>
                    <div class="text-lg font-bold text-purple-600">${todayGoals.progress.xpEarned} / ${todayGoals.goals.xp}</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div class="bg-purple-500 rounded-full h-2 transition-all" style="width: ${Math.min((todayGoals.progress.xpEarned / todayGoals.goals.xp) * 100, 100)}%"></div>
                    </div>
                </div>
            `;
        }
        
        function updateRecentBadges() {
            const container = document.getElementById('recentBadgesContainer');
            
            if (achievements.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4 w-full">まだバッジを獲得していません</div>';
                return;
            }
            
            const recentBadges = achievements.slice(-6); // 最新6個
            container.innerHTML = '';
            
            recentBadges.forEach(badgeId => {
                const badge = badgeDefinitions[badgeId];
                if (!badge) return;
                
                const rarityColors = {
                    'common': 'border-gray-300 bg-gray-50',
                    'uncommon': 'border-green-300 bg-green-50',
                    'rare': 'border-blue-300 bg-blue-50',
                    'epic': 'border-purple-300 bg-purple-50',
                    'legendary': 'border-yellow-300 bg-yellow-50'
                };
                
                const badgeElement = document.createElement('div');
                badgeElement.className = `${rarityColors[badge.rarity]} border-2 rounded-lg p-3 text-center min-w-[80px] hover:scale-105 transition-transform cursor-pointer`;
                badgeElement.innerHTML = `
                    <div class="text-2xl mb-1">${badge.icon}</div>
                    <div class="text-xs font-medium text-gray-700">${badge.name}</div>
                `;
                badgeElement.title = badge.description;
                
                container.appendChild(badgeElement);
            });
        }
        
        function showAllBadges() {
            document.getElementById('badgeModal').classList.remove('hidden');
            updateAllBadgesDisplay();
        }
        
        function closeBadgeModal() {
            document.getElementById('badgeModal').classList.add('hidden');
        }
        
        function updateAllBadgesDisplay() {
            const container = document.getElementById('allBadgesContainer');
            const totalBadges = Object.keys(badgeDefinitions).length;
            const earnedBadges = achievements.length;
            const completionRate = Math.round((earnedBadges / totalBadges) * 100);
            
            document.getElementById('earnedBadgeCount').textContent = earnedBadges;
            document.getElementById('totalBadgeCount').textContent = totalBadges;
            document.getElementById('badgeCompletionRate').textContent = completionRate + '%';
            document.getElementById('badgeProgressBar').style.width = completionRate + '%';
            
            container.innerHTML = '';
            
            Object.entries(badgeDefinitions).forEach(([badgeId, badge]) => {
                const isEarned = achievements.includes(badgeId);
                
                const rarityColors = {
                    'common': isEarned ? 'border-gray-400 bg-gray-100' : 'border-gray-200 bg-gray-50',
                    'uncommon': isEarned ? 'border-green-400 bg-green-100' : 'border-green-200 bg-green-50',
                    'rare': isEarned ? 'border-blue-400 bg-blue-100' : 'border-blue-200 bg-blue-50',
                    'epic': isEarned ? 'border-purple-400 bg-purple-100' : 'border-purple-200 bg-purple-50',
                    'legendary': isEarned ? 'border-yellow-400 bg-yellow-100' : 'border-yellow-200 bg-yellow-50'
                };
                
                const badgeElement = document.createElement('div');
                badgeElement.className = `${rarityColors[badge.rarity]} border-2 rounded-lg p-4 text-center ${isEarned ? '' : 'opacity-50'}`;
                badgeElement.innerHTML = `
                    <div class="text-3xl mb-2 ${isEarned ? '' : 'grayscale'}">${badge.icon}</div>
                    <div class="font-bold text-sm mb-1">${badge.name}</div>
                    <div class="text-xs text-gray-600 mb-2">${badge.description}</div>
                    <div class="text-xs px-2 py-1 rounded-full ${isEarned ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-600'}">
                        ${isEarned ? '獲得済み' : '未獲得'}
                    </div>
                `;
                
                container.appendChild(badgeElement);
            });
        }

        function updateCategoryGrid() {
            const container = document.getElementById('categoryGrid');
            container.innerHTML = '';
            
            // カテゴリアイコンマッピング
            const categoryIcons = {
                'SEO': '🔍',
                'HTML': '🏗️',
                '広告': '📢',
                'CSS': '🎨',
                'リテラシー': '🛡️',
                'WordPress': '📝',
                'メール': '📧',
                'コンテンツ': '📄',
                'EC': '🛒',
                'AI': '🤖'
            };
            
            if (originalQuestions.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">データを読み込み中...</div>';
                return;
            }
            
            const categories = [...new Set(originalQuestions.map(q => q.category || '未分類'))].sort();
            
            categories.forEach(category => {
                const categoryQuestions = originalQuestions.filter(q => (q.category || '未分類') === category);
                const icon = categoryIcons[category] || '📝';
                
                // プラン制限チェック
                const freeQuestions = categoryQuestions.filter(q => (q.difficulty || '未設定') === '初級');
                const isLocked = currentUser.plan === 'free' && freeQuestions.length === 0;
                
                // 利用可能な問題数を計算
                let availableCount = categoryQuestions.length;
                let displayText = `${availableCount}問`;
                
                if (currentUser.plan === 'free') {
                    availableCount = freeQuestions.length;
                    if (availableCount < categoryQuestions.length) {
                        displayText = `${availableCount}問 (初級のみ)`;
                    }
                }
                
                const card = document.createElement('div');
                card.className = `canva-card rounded-2xl p-4 sm:p-6 text-center cursor-pointer transition-all hover:scale-105 hover:shadow-lg ${isLocked ? 'opacity-60' : ''}`;
                
                card.innerHTML = `
                    <div class="text-3xl sm:text-4xl mb-3">${icon}</div>
                    <h4 class="font-bold text-gray-800 mb-2 text-sm sm:text-base">${category}</h4>
                    <p class="text-xs sm:text-sm text-gray-600 mb-3">${displayText}</p>
                    ${isLocked ? 
                        '<div class="text-xs text-orange-600 font-medium">🔒 プレミアム限定</div>' : 
                        '<div class="text-xs text-green-600 font-medium">✓ 利用可能</div>'
                    }
                `;
                
                card.onclick = () => {
                    if (isLocked) {
                        showUpgradeModal();
                    } else {
                        selectCategory(category);
                    }
                };
                
                container.appendChild(card);
            });
        }

        function selectCategory(category) {
            selectedCategory = category;
            
            // 設定画面を表示
            document.getElementById('homeContainer').classList.add('hidden');
            document.getElementById('setupPanel').classList.remove('hidden');
            
            // 難易度選択肢を更新
            updateDifficultyOptions(category);
        }

        function updateDifficultyOptions(category) {
            const difficultySelect = document.getElementById('difficultySelect');
            
            let categoryQuestions = originalQuestions;
            if (category !== 'all') {
                categoryQuestions = categoryQuestions.filter(q => (q.category || '未分類') === category);
            }
            
            const difficulties = [...new Set(categoryQuestions.map(q => q.difficulty || '未設定'))].sort();
            
            difficultySelect.innerHTML = '';
            
            // 「すべての難易度」の問題数を計算
            const allDifficultyOption = document.createElement('option');
            allDifficultyOption.value = 'all';
            allDifficultyOption.textContent = `すべての難易度 (${categoryQuestions.length}問)`;
            difficultySelect.appendChild(allDifficultyOption);
            
            // 各難易度の問題数を計算
            difficulties.forEach(difficulty => {
                const difficultyQuestions = categoryQuestions.filter(q => (q.difficulty || '未設定') === difficulty);
                
                const option = document.createElement('option');
                option.value = difficulty;
                option.textContent = `${difficulty} (${difficultyQuestions.length}問)`;
                difficultySelect.appendChild(option);
            });
            
            // 問題数表示を更新
            document.getElementById('difficultyCount').textContent = categoryQuestions.length;
        }

        function updateRecentHistory() {
            const container = document.getElementById('recentHistory');
            
            if (quizHistory.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">まだ学習履歴がありません。<br>クイズに挑戦してみましょう！</div>';
                return;
            }
            
            const recentQuizzes = quizHistory.slice(-5).reverse();
            
            container.innerHTML = '';
            recentQuizzes.forEach((quiz, index) => {
                const date = new Date(quiz.date);
                const dateStr = date.toLocaleDateString('ja-JP', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const historyItem = document.createElement('div');
                historyItem.className = 'flex items-center justify-between p-3 sm:p-4 bg-gray-50 rounded-lg fade-in';
                historyItem.style.animationDelay = `${index * 0.1}s`;
                
                const accuracyColor = quiz.accuracy >= 80 ? 'text-green-600' : quiz.accuracy >= 60 ? 'text-yellow-600' : 'text-red-600';
                
                historyItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="text-lg sm:text-xl">${quiz.accuracy >= 80 ? '🏆' : quiz.accuracy >= 60 ? '👍' : '📚'}</div>
                        <div>
                            <div class="font-medium text-gray-800 text-sm sm:text-base">${quiz.category || 'すべて'}</div>
                            <div class="text-xs sm:text-sm text-gray-500">${dateStr}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold ${accuracyColor} text-sm sm:text-base">${quiz.accuracy}%</div>
                        <div class="text-xs sm:text-sm text-gray-500">${quiz.score}/${quiz.total}問</div>
                    </div>
                `;
                
                container.appendChild(historyItem);
            });
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function upgradeToPremium() {
            // デモ版では即座にアップグレード
            currentUser.plan = 'premium';
            
            // 更新されたユーザー情報を保存
            saveUserSession(currentUser);
            
            alert('プレミアムプランにアップグレードしました！\n中級・上級問題にアクセスできるようになりました。');
            closeUpgradeModal();
            showMainApp();
            
            // Google Analytics イベント
            if (typeof gtag !== 'undefined') {
                gtag('event', 'purchase', {
                    transaction_id: 'demo_upgrade_' + Date.now(),
                    value: 980,
                    currency: 'JPY',
                    items: [{
                        item_id: 'premium_plan',
                        item_name: 'プレミアムプラン',
                        category: 'subscription',
                        quantity: 1,
                        price: 980
                    }]
                });
            }
        }

        function refreshSpreadsheetData() {
            const savedUrl = localStorage.getItem('spreadsheetUrl');
            if (!savedUrl) {
                alert('保存されたスプレッドシートURLがありません。\n最初にスプレッドシートを読み込んでください。');
                return;
            }
            
            // 保存されたURLを入力欄に設定
            document.getElementById('spreadsheetUrl').value = savedUrl;
            
            // データを再読み込み
            loadFromSpreadsheet();
        }

        function loadSampleData() {
            originalQuestions = [...sampleQuestions];
            questions = [...originalQuestions];
            
            // 最終更新時刻を保存
            const now = new Date().toLocaleString('ja-JP');
            localStorage.setItem('lastDataUpdate', now);
            
            // データをローカルストレージに保存
            localStorage.setItem('quizQuestions', JSON.stringify(originalQuestions));
            
            // 全ての画面を強制更新
            updateAdminDashboard();
            updateCategoryGrid();
            updateHomeStats();
            updateRecentHistory();
            updateDifficultyOptions(selectedCategory);
            
            console.log('サンプルデータ読み込み完了:', originalQuestions.length + '問');
        }



        function validateQuestions(questionsToValidate) {
            const errors = [];
            const warnings = [];
            let validCount = 0;

            questionsToValidate.forEach((q, index) => {
                const questionNum = index + 1;
                
                // 必須フィールドチェック
                if (!q.question || q.question.trim() === '') {
                    errors.push(`問題${questionNum}: 問題文が空です`);
                }
                if (!q.type || !['single', 'multiple', 'truefalse'].includes(q.type)) {
                    errors.push(`問題${questionNum}: 問題タイプが無効です (single, multiple, truefalse のいずれかを指定)`);
                }
                if (!q.options || q.options.length === 0) {
                    errors.push(`問題${questionNum}: 選択肢が設定されていません`);
                }
                if (!q.correct || q.correct.length === 0) {
                    errors.push(`問題${questionNum}: 正解が設定されていません`);
                }

                // 選択肢と正解の整合性チェック（文字の正規化対応）
                if (q.options && q.correct) {
                    q.correct.forEach(correctAnswer => {
                        const normalizedCorrect = normalizeText(correctAnswer);
                        const hasMatch = q.options.some(option => normalizeText(option) === normalizedCorrect);
                        
                        if (!hasMatch) {
                            errors.push(`問題${questionNum}: 正解「${correctAnswer}」が選択肢に含まれていません`);
                        }
                    });
                }

                // 問題タイプ別チェック
                if (q.type === 'truefalse' && q.options && q.options.length !== 2) {
                    warnings.push(`問題${questionNum}: ○×問題は選択肢が2つである必要があります`);
                }
                if (q.type === 'single' && q.correct && q.correct.length > 1) {
                    warnings.push(`問題${questionNum}: 択一選択問題の正解は1つである必要があります`);
                }

                if (errors.length === 0) validCount++;
            });

            return {
                isValid: errors.length === 0,
                totalQuestions: questionsToValidate.length,
                validQuestions: validCount,
                errors: errors,
                warnings: warnings
            };
        }

        function showValidationResults(validation) {
            const container = document.getElementById('validationResults');
            container.innerHTML = '';
            
            if (validation.errors.length === 0 && validation.warnings.length === 0) {
                container.innerHTML = `
                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <span class="text-green-600 mr-2">✅</span>
                            <span class="text-green-700 font-medium">データ検証完了: ${validation.totalQuestions}問すべて正常です</span>
                        </div>
                    </div>
                `;
            } else {
                let html = '<div class="space-y-3">';
                
                if (validation.errors.length > 0) {
                    html += `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="font-medium text-red-800 mb-2">❌ エラー (${validation.errors.length}件)</div>
                            <ul class="text-sm text-red-700 space-y-1">
                                ${validation.errors.map(error => `<li>• ${error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (validation.warnings.length > 0) {
                    html += `
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="font-medium text-yellow-800 mb-2">⚠️ 警告 (${validation.warnings.length}件)</div>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                ${validation.warnings.map(warning => `<li>• ${warning}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
            }
            
            container.classList.remove('hidden');
        }

        async function loadFromSpreadsheet() {
            const url = document.getElementById('spreadsheetUrl').value.trim();
            if (!url) {
                alert('スプレッドシートのURLを入力してください');
                return;
            }

            try {
                // スプレッドシートIDを抽出
                const sheetId = extractSheetId(url);
                if (!sheetId) {
                    throw new Error('無効なスプレッドシートURLです');
                }
                
                // CSV形式でデータを取得（公開設定が必要）
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                
                document.getElementById('loadingMessage').classList.remove('hidden');
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const parsedQuestions = parseCSV(csvText);
                
                if (parsedQuestions.length === 0) {
                    throw new Error('問題データが見つかりませんでした');
                }
                
                originalQuestions = parsedQuestions;
                const validation = validateQuestions(originalQuestions);
                showValidationResults(validation);
                
                document.getElementById('loadingMessage').classList.add('hidden');
                
                if (validation.isValid) {
                    questions = [...originalQuestions];
                    
                    // 最終更新時刻を保存
                    const now = new Date().toLocaleString('ja-JP');
                    localStorage.setItem('lastDataUpdate', now);
                    
                    // スプレッドシートURLを保存
                    localStorage.setItem('spreadsheetUrl', url);
                    
                    // データをローカルストレージに保存
                    localStorage.setItem('quizQuestions', JSON.stringify(originalQuestions));
                    
                    alert(`${questions.length}問の問題を読み込みました！`);
                    
                    // 全ての画面を強制更新
                    updateAdminDashboard();
                    updateCategoryGrid();
                    updateHomeStats();
                    updateRecentHistory();
                    
                    // 設定画面の難易度選択肢も更新
                    updateDifficultyOptions(selectedCategory);
                    
                    console.log('データ更新完了:', originalQuestions.length + '問');
                } else {
                    alert(`データにエラーがあります。${validation.errors.length}件のエラーを修正してください。`);
                }
                
            } catch (error) {
                document.getElementById('loadingMessage').classList.add('hidden');
                console.error('データの読み込みに失敗しました:', error);
                alert(`データの読み込みに失敗しました: ${error.message}\n\n確認事項:\n1. スプレッドシートが「リンクを知っている全員が閲覧可能」に設定されているか\n2. URLが正しいか\n3. データが正しい形式で入力されているか`);
            }
        }

        function extractSheetId(url) {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const questions = [];
            
            // ヘッダー行をスキップ（もしあれば）
            const startIndex = lines[0].includes('問題文') ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // CSVの行を解析（カンマ区切り、ダブルクォート対応）
                const columns = parseCSVLine(line);
                
                if (columns.length >= 4) {
                    const [questionText, type, optionsStr, correctStr, categoryStr, difficultyStr, explanationStr] = columns;
                    
                    if (questionText && type && optionsStr && correctStr) {
                        const options = optionsStr.split(',').map(opt => normalizeText(opt));
                        const correct = correctStr.split(',').map(ans => normalizeText(ans));
                        const category = categoryStr ? categoryStr.trim() : '未分類';
                        const difficulty = difficultyStr ? difficultyStr.trim() : '未設定';
                        const explanation = explanationStr ? explanationStr.trim() : '';
                        
                        questions.push({
                            question: questionText.trim(),
                            type: type.trim(),
                            options: options,
                            correct: correct,
                            category: category,
                            difficulty: difficulty,
                            explanation: explanation
                        });
                    }
                }
            }
            
            return questions;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function startQuiz() {
            if (originalQuestions.length === 0) {
                alert('問題データが読み込まれていません');
                return;
            }

            // カテゴリと難易度でフィルタリング
            const selectedDifficulty = document.getElementById('difficultySelect').value;
            let filteredQuestions = [...originalQuestions];
            
            if (selectedCategory !== 'all') {
                filteredQuestions = filteredQuestions.filter(q => (q.category || '未分類') === selectedCategory);
            }
            
            if (selectedDifficulty !== 'all') {
                filteredQuestions = filteredQuestions.filter(q => (q.difficulty || '未設定') === selectedDifficulty);
            }
            
            // プラン制限チェック
            if (currentUser.plan === 'free') {
                const restrictedQuestions = filteredQuestions.filter(q => 
                    (q.difficulty || '未設定') === '中級' || (q.difficulty || '未設定') === '上級'
                );
                
                if (restrictedQuestions.length > 0) {
                    const freeQuestions = filteredQuestions.filter(q => (q.difficulty || '未設定') === '初級');
                    
                    if (freeQuestions.length === 0) {
                        alert('選択された条件の問題はプレミアムプラン限定です。\n無料プランでは初級問題のみご利用いただけます。');
                        showUpgradeModal();
                        return;
                    } else {
                        const confirmResult = confirm(
                            `選択された条件には中級・上級問題が含まれています。\n` +
                            `無料プランでは初級問題（${freeQuestions.length}問）のみ利用可能です。\n\n` +
                            `初級問題のみでクイズを開始しますか？`
                        );
                        
                        if (!confirmResult) {
                            return;
                        }
                        
                        filteredQuestions = freeQuestions;
                    }
                }
            }
            
            if (filteredQuestions.length === 0) {
                alert('選択されたカテゴリに問題がありません');
                return;
            }

            // 問題数制限
            const questionLimit = document.getElementById('questionLimit').value;
            if (questionLimit !== 'all') {
                const limit = parseInt(questionLimit);
                if (filteredQuestions.length > limit) {
                    filteredQuestions = filteredQuestions.slice(0, limit);
                }
            }

            // シャッフル設定の確認
            const shuffleMode = document.getElementById('shuffleMode').value;
            if (shuffleMode === 'shuffle') {
                questions = shuffleArray(filteredQuestions);
            } else {
                questions = [...filteredQuestions];
            }

            // タイマー設定
            const timeLimitMinutes = parseInt(document.getElementById('timeLimit').value);
            if (timeLimitMinutes > 0) {
                timeRemaining = timeLimitMinutes * 60; // 秒に変換
                document.getElementById('timerDisplay').classList.remove('hidden');
                startTimer();
            } else {
                document.getElementById('timerDisplay').classList.add('hidden');
            }

            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('quizContainer').classList.remove('hidden');
            
            currentQuestionIndex = 0;
            userAnswers = [];
            selectedAnswers.clear();
            quizStartTime = new Date();
            
            displayQuestion();
            
            // Google Analytics イベント
            if (typeof gtag !== 'undefined') {
                gtag('event', 'quiz_start', {
                    category: selectedCategory,
                    difficulty: selectedDifficulty,
                    question_count: questions.length
                });
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert('時間切れです！クイズを終了します。');
                    showResults();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timeRemaining').textContent = display;
            
            // 残り時間が少なくなったら色を変更
            const timerElement = document.getElementById('timerDisplay');
            if (timeRemaining <= 60) {
                timerElement.className = timerElement.className.replace('text-orange-600', 'text-red-600');
            } else if (timeRemaining <= 300) {
                timerElement.className = timerElement.className.replace('text-orange-600', 'text-yellow-600');
            }
        }

        function displayQuestion() {
            const question = questions[currentQuestionIndex];
            selectedAnswers.clear();
            
            // 問題情報の更新
            document.getElementById('questionNumber').textContent = `問題 ${currentQuestionIndex + 1}`;
            document.getElementById('questionText').textContent = question.question;
            
            // 問題タイプ、カテゴリ、難易度の表示
            const typeText = {
                'single': '択一選択',
                'multiple': '複数選択',
                'truefalse': '○×問題'
            };
            document.getElementById('questionType').textContent = typeText[question.type] || '択一選択';
            document.getElementById('questionCategory').textContent = question.category || '未分類';
            document.getElementById('questionDifficulty').textContent = question.difficulty || '未設定';
            
            // プログレスバーの更新
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${currentQuestionIndex + 1} / ${questions.length}`;
            
            // 選択肢の生成
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button w-full bg-white hover:bg-gray-50 text-gray-800 p-4 rounded-lg border-2 border-gray-200 text-left font-medium fade-in';
                button.style.animationDelay = `${index * 0.1}s`;
                button.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-sm font-bold mr-4">
                            ${String.fromCharCode(65 + index)}
                        </span>
                        <span>${option}</span>
                    </div>
                `;
                
                button.onclick = () => selectOption(button, option, question.type);
                container.appendChild(button);
            });
            
            // ボタンの状態更新
            document.getElementById('prevButton').disabled = currentQuestionIndex === 0;
            const nextButton = document.getElementById('nextButton');
            nextButton.textContent = currentQuestionIndex === questions.length - 1 ? '結果を見る' : '次の問題 →';
            
            // 複数選択以外は次へボタンを無効化（回答後に有効化）
            if (question.type === 'single' || question.type === 'truefalse') {
                nextButton.disabled = true;
                nextButton.style.opacity = '0.5';
            } else {
                nextButton.disabled = false;
                nextButton.style.opacity = '1';
            }
            
            // 広告表示制御（5問ごと、無料プランのみ）
            if (currentUser.plan === 'free' && currentQuestionIndex > 0 && currentQuestionIndex % 5 === 0) {
                document.getElementById('adSpace4').style.display = 'block';
            } else {
                document.getElementById('adSpace4').style.display = 'none';
            }
        }

        function selectOption(button, option, type) {
            if (type === 'single' || type === 'truefalse') {
                // 単一選択：他の選択を解除
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('option-selected');
                });
                
                button.classList.add('option-selected');
                createParticles(button);
                
                selectedAnswers.clear();
                selectedAnswers.add(option);
                
                // 即座に正誤判定を表示
                showAnswerFeedback(option, type);
                
            } else if (type === 'multiple') {
                // 複数選択：トグル
                if (selectedAnswers.has(option)) {
                    selectedAnswers.delete(option);
                    button.classList.remove('option-selected');
                } else {
                    selectedAnswers.add(option);
                    button.classList.add('option-selected');
                    createParticles(button);
                }
            }
        }

        function showAnswerFeedback(selectedOption, type) {
            const question = questions[currentQuestionIndex];
            const correctAnswers = question.correct;
            
            // 単一選択・○×問題の場合のみ即座にフィードバック
            if (type === 'single' || type === 'truefalse') {
                const isCorrect = correctAnswers.includes(selectedOption);
                
                // 全ての選択肢に正誤を表示
                document.querySelectorAll('.option-button').forEach(btn => {
                    const optionText = btn.querySelector('span:last-child').textContent;
                    
                    if (correctAnswers.includes(optionText)) {
                        btn.classList.add('correct');
                        btn.classList.remove('option-button');
                    } else if (optionText === selectedOption && !isCorrect) {
                        btn.classList.add('incorrect');
                        btn.classList.remove('option-button');
                    }
                    
                    // ボタンを無効化
                    btn.disabled = true;
                    btn.style.pointerEvents = 'none';
                });
                
                // 解説を表示（プレミアムプランのみ）
                if (currentUser.plan === 'premium' && question.explanation) {
                    setTimeout(() => {
                        showExplanation(question.explanation, isCorrect);
                    }, 1000);
                }
                
                // 次の問題ボタンを有効化
                setTimeout(() => {
                    document.getElementById('nextButton').disabled = false;
                    document.getElementById('nextButton').style.opacity = '1';
                }, 1500);
            }
        }

        function showExplanation(explanation, isCorrect) {
            // 既存の解説を削除
            const existingExplanation = document.getElementById('explanationCard');
            if (existingExplanation) {
                existingExplanation.remove();
            }
            
            const explanationCard = document.createElement('div');
            explanationCard.id = 'explanationCard';
            explanationCard.className = `mt-6 p-4 rounded-lg border-l-4 ${isCorrect ? 'bg-green-50 border-green-400' : 'bg-blue-50 border-blue-400'} fade-in`;
            explanationCard.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0 mr-3">
                        <span class="text-2xl">${isCorrect ? '✅' : '💡'}</span>
                    </div>
                    <div>
                        <h4 class="font-semibold ${isCorrect ? 'text-green-800' : 'text-blue-800'} mb-2">
                            ${isCorrect ? '正解です！' : '解説'}
                        </h4>
                        <p class="${isCorrect ? 'text-green-700' : 'text-blue-700'}">${explanation}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('optionsContainer').appendChild(explanationCard);
        }

        function nextQuestion() {
            // 回答を保存
            userAnswers[currentQuestionIndex] = Array.from(selectedAnswers);
            
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showResults();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
                
                // 前の回答を復元
                if (userAnswers[currentQuestionIndex]) {
                    selectedAnswers = new Set(userAnswers[currentQuestionIndex]);
                    
                    document.querySelectorAll('.option-button').forEach(button => {
                        const optionText = button.querySelector('span:last-child').textContent;
                        if (selectedAnswers.has(optionText)) {
                            button.classList.add('option-selected');
                        }
                    });
                }
            }
        }

        function showResults() {
            // タイマーを停止
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.remove('hidden');
            
            let correctCount = 0;
            const quizEndTime = new Date();
            const timeSpent = Math.round((quizEndTime - quizStartTime) / 1000); // 秒
            
            questions.forEach((question, index) => {
                const userAnswer = userAnswers[index] || [];
                const correctAnswer = question.correct;
                
                // 配列の内容を比較
                const isCorrect = arraysEqual(userAnswer.sort(), correctAnswer.sort());
                if (isCorrect) correctCount++;
            });
            
            const totalQuestions = questions.length;
            const incorrectCount = totalQuestions - correctCount;
            const accuracy = Math.round((correctCount / totalQuestions) * 100);
            
            document.getElementById('finalScore').textContent = `${correctCount}/${totalQuestions}`;
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('incorrectCount').textContent = incorrectCount;
            document.getElementById('accuracyRate').textContent = `${accuracy}%`;
            
            // 結果をローカルストレージに保存
            const result = {
                correctCount,
                totalQuestions,
                accuracy,
                timeSpent,
                questions: questions.map((q, index) => ({
                    question: q.question,
                    category: q.category,
                    difficulty: q.difficulty,
                    userAnswer: userAnswers[index] || [],
                    correctAnswer: q.correct,
                    isCorrect: arraysEqual((userAnswers[index] || []).sort(), q.correct.sort())
                }))
            };
            
            saveQuizResult(result);
            
            // 称号チェック（満点の場合のみ）
            if (correctCount === totalQuestions) {
                checkAndShowAchievement();
                createConfetti();
            }
            
            // Google Analytics イベント
            if (typeof gtag !== 'undefined') {
                gtag('event', 'quiz_complete', {
                    score: correctCount,
                    total: totalQuestions,
                    accuracy: accuracy,
                    time_spent: timeSpent
                });
            }
        }
        
        function checkAndShowAchievement() {
            const selectedCategory = document.getElementById('categorySelect').value;
            const selectedDifficulty = document.getElementById('difficultySelect').value;
            
            let achievementTitle = '';
            let achievementDescription = '';
            
            // カテゴリと難易度に基づいて称号を決定
            if (selectedCategory !== 'all' && selectedDifficulty !== 'all') {
                // 特定のカテゴリ・難易度
                achievementTitle = `${selectedCategory} ${selectedDifficulty}マスター`;
                achievementDescription = `${selectedCategory}の${selectedDifficulty}レベル問題を全問正解しました！`;
            } else if (selectedCategory !== 'all') {
                // 特定のカテゴリ（全難易度）
                achievementTitle = `${selectedCategory} エキスパート`;
                achievementDescription = `${selectedCategory}の全難易度問題を制覇しました！`;
            } else if (selectedDifficulty !== 'all') {
                // 特定の難易度（全カテゴリ）
                achievementTitle = `${selectedDifficulty} チャンピオン`;
                achievementDescription = `${selectedDifficulty}レベルの全カテゴリ問題を制覇しました！`;
            } else {
                // 全問題
                achievementTitle = 'グランドマスター';
                achievementDescription = 'すべての問題を完璧に解答しました！真の道場マスターです！';
            }
            
            // 称号表示
            document.getElementById('achievementTitle').textContent = achievementTitle;
            document.getElementById('achievementDescription').textContent = achievementDescription;
            document.getElementById('achievementSection').classList.remove('hidden');
        }

        function showDetailedResults() {
            document.getElementById('detailedResults').classList.remove('hidden');
            const container = document.getElementById('detailedResultsList');
            container.innerHTML = '';
            
            questions.forEach((question, index) => {
                const userAnswer = userAnswers[index] || [];
                const correctAnswer = question.correct;
                const isCorrect = arraysEqual(userAnswer.sort(), correctAnswer.sort());
                
                const resultCard = document.createElement('div');
                resultCard.className = `border rounded-lg p-4 ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} fade-in`;
                resultCard.style.animationDelay = `${index * 0.1}s`;
                
                const typeText = {
                    'single': '択一選択',
                    'multiple': '複数選択',
                    'truefalse': '○×問題'
                };
                
                let explanationHtml = '';
                if (currentUser.plan === 'premium' && question.explanation) {
                    explanationHtml = `
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                            <div class="flex items-start">
                                <span class="text-blue-500 mr-2 mt-1">💡</span>
                                <div>
                                    <h5 class="font-medium text-blue-800 mb-1">解説</h5>
                                    <p class="text-blue-700 text-sm">${question.explanation}</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (currentUser.plan === 'free') {
                    explanationHtml = `
                        <div class="mt-4 p-3 bg-gray-50 rounded-lg border-l-4 border-gray-300">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-gray-400 mr-2">🔒</span>
                                    <span class="text-gray-600 text-sm">解説はプレミアムプラン限定です</span>
                                </div>
                                <button onclick="showUpgradeModal()" class="text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full hover:shadow-lg transition-all">
                                    アップグレード
                                </button>
                            </div>
                        </div>
                    `;
                }

                resultCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-lg ${isCorrect ? 'text-green-600' : 'text-red-600'} mr-2">
                                ${isCorrect ? '✅' : '❌'}
                            </span>
                            <span class="font-medium text-gray-800">問題 ${index + 1}</span>
                            <span class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-600 rounded">${question.category || '未分類'}</span>
                            <span class="ml-1 px-2 py-1 text-xs bg-purple-100 text-purple-600 rounded">${question.difficulty || '未設定'}</span>
                            <span class="ml-1 px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">${typeText[question.type]}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p class="text-gray-800 font-medium mb-2">${question.question}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-3">
                        <div>
                            <span class="font-medium text-gray-600">あなたの回答:</span>
                            <div class="mt-1">
                                ${userAnswer.length > 0 ? 
                                    userAnswer.map(ans => `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1 mb-1">${ans}</span>`).join('') : 
                                    '<span class="text-gray-400">未回答</span>'
                                }
                            </div>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">正解:</span>
                            <div class="mt-1">
                                ${correctAnswer.map(ans => `<span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded mr-1 mb-1">${ans}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                    ${explanationHtml}
                `;
                
                container.appendChild(resultCard);
            });
        }

        function hideDetailedResults() {
            document.getElementById('detailedResults').classList.add('hidden');
        }

        function arraysEqual(a, b) {
            return a.length === b.length && a.every((val, index) => val === b[index]);
        }

        function restartQuiz() {
            // タイマーをクリア
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('detailedResults').classList.add('hidden');
            document.getElementById('achievementSection').classList.add('hidden');
            document.getElementById('setupPanel').classList.remove('hidden');
            
            currentQuestionIndex = 0;
            userAnswers = [];
            selectedAnswers.clear();
            timeRemaining = 0;
            quizStartTime = null;
        }

        // テーマ管理
        let currentTheme = localStorage.getItem('theme') || 
                          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

        function initializeTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeIcon();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
            
            // Google Analytics イベント
            if (typeof gtag !== 'undefined') {
                gtag('event', 'theme_change', {
                    theme: currentTheme
                });
            }
        }

        function updateThemeIcon() {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = currentTheme === 'light' ? '🌙' : '☀️';
            }
        }

        // キーボード操作サポート
        function initializeKeyboardSupport() {
            document.addEventListener('keydown', function(e) {
                // クイズ画面でのキーボード操作
                if (!document.getElementById('quizContainer').classList.contains('hidden')) {
                    const optionButtons = document.querySelectorAll('.option-button:not([disabled])');
                    
                    // 数字キー (1-4) で選択肢を選択
                    if (e.key >= '1' && e.key <= '4') {
                        const index = parseInt(e.key) - 1;
                        if (optionButtons[index]) {
                            optionButtons[index].click();
                            e.preventDefault();
                        }
                    }
                    
                    // Enterキーで次の問題へ
                    if (e.key === 'Enter' && !document.getElementById('nextButton').disabled) {
                        document.getElementById('nextButton').click();
                        e.preventDefault();
                    }
                    
                    // Backspaceで前の問題へ
                    if (e.key === 'Backspace' && !document.getElementById('prevButton').disabled) {
                        document.getElementById('prevButton').click();
                        e.preventDefault();
                    }
                }
                
                // グローバルキーボードショートカット
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'd': // Ctrl+D でダークモード切り替え
                            toggleTheme();
                            e.preventDefault();
                            break;
                        case 'h': // Ctrl+H でホームに戻る
                            if (currentUser) {
                                showHome();
                                e.preventDefault();
                            }
                            break;
                    }
                }
                
                // Escキーでモーダルを閉じる
                if (e.key === 'Escape') {
                    const upgradeModal = document.getElementById('upgradeModal');
                    if (!upgradeModal.classList.contains('hidden')) {
                        closeUpgradeModal();
                    }
                }
            });
        }

        // フォーカス管理
        function manageFocus() {
            // モーダルが開いた時のフォーカストラップ
            const upgradeModal = document.getElementById('upgradeModal');
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (!upgradeModal.classList.contains('hidden')) {
                            // モーダル内の最初のフォーカス可能要素にフォーカス
                            const firstFocusable = upgradeModal.querySelector('button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
                            if (firstFocusable) {
                                firstFocusable.focus();
                            }
                        }
                    }
                });
            });
            observer.observe(upgradeModal, { attributes: true });
        }

        // Phase 2: ゲーミフィケーション - レベルシステム
        let userLevel = JSON.parse(localStorage.getItem('userLevel') || '{"level": 1, "totalXP": 0}');
        let achievements = JSON.parse(localStorage.getItem('achievements') || '[]');
        let dailyGoals = JSON.parse(localStorage.getItem('dailyGoals') || '{}');
        let learningStreak = JSON.parse(localStorage.getItem('learningStreak') || '{"current": 0, "best": 0, "lastDate": null}');

        // レベル閾値（各レベルに必要な累計XP）
        const levelThresholds = [
            0, 100, 250, 450, 700, 1000, 1350, 1750, 2200, 2700, 3250, 3850, 4500, 5200, 5950, 6750, 7600, 8500, 9450, 10500
        ];

        // バッジ定義
        const badgeDefinitions = {
            'first_quiz': {
                name: '初回挑戦',
                description: '初めてクイズに挑戦しました',
                icon: '🎯',
                rarity: 'common'
            },
            'perfect_score': {
                name: '満点獲得',
                description: 'クイズで満点を取りました',
                icon: '🏆',
                rarity: 'uncommon'
            },
            'streak_3': {
                name: '3日連続',
                description: '3日連続で学習しました',
                icon: '🔥',
                rarity: 'uncommon'
            },
            'streak_7': {
                name: '1週間連続',
                description: '7日連続で学習しました',
                icon: '⚡',
                rarity: 'rare'
            },
            'streak_30': {
                name: '1ヶ月連続',
                description: '30日連続で学習しました',
                icon: '💎',
                rarity: 'legendary'
            },
            'seo_master': {
                name: 'SEOマスター',
                description: 'SEO問題を10問以上正解しました',
                icon: '🔍',
                rarity: 'rare'
            },
            'ai_expert': {
                name: 'AI専門家',
                description: 'AI問題を10問以上正解しました',
                icon: '🤖',
                rarity: 'rare'
            },
            'early_bird': {
                name: '早起き学習者',
                description: '朝6時前に学習しました',
                icon: '🌅',
                rarity: 'uncommon'
            },
            'night_owl': {
                name: '夜更かし学習者',
                description: '夜22時以降に学習しました',
                icon: '🦉',
                rarity: 'uncommon'
            },
            'comeback_kid': {
                name: 'カムバックキッド',
                description: '7日ぶりに学習を再開しました',
                icon: '🎭',
                rarity: 'rare'
            },
            'perfectionist': {
                name: '完璧主義者',
                description: '5回連続で満点を取りました',
                icon: '💯',
                rarity: 'epic'
            },
            'grand_master': {
                name: 'グランドマスター',
                description: 'レベル20に到達しました',
                icon: '👑',
                rarity: 'legendary'
            },
            'explorer': {
                name: '探検家',
                description: '全カテゴリの問題に挑戦しました',
                icon: '🗺️',
                rarity: 'epic'
            },
            'speed_demon': {
                name: 'スピードデーモン',
                description: '1問を10秒以内で正解しました',
                icon: '⚡',
                rarity: 'rare'
            },
            'knowledge_seeker': {
                name: '知識探求者',
                description: '100問以上に挑戦しました',
                icon: '📚',
                rarity: 'epic'
            }
        };

        // XP計算
        function calculateXP(correctCount, totalQuestions, difficulty) {
            const baseXP = correctCount * 10;
            const difficultyMultiplier = {
                '初級': 1.0,
                '中級': 1.5,
                '上級': 2.0,
                '未設定': 1.0
            };
            const accuracyBonus = (correctCount / totalQuestions) >= 0.8 ? 20 : 0;
            
            return Math.round(baseXP * (difficultyMultiplier[difficulty] || 1.0) + accuracyBonus);
        }

        // レベルアップ処理
        function updateUserLevel(xpGained) {
            userLevel.totalXP += xpGained;
            
            // 新しいレベルを計算
            let newLevel = 1;
            for (let i = levelThresholds.length - 1; i >= 0; i--) {
                if (userLevel.totalXP >= levelThresholds[i]) {
                    newLevel = i + 1;
                    break;
                }
            }
            
            const leveledUp = newLevel > userLevel.level;
            userLevel.level = newLevel;
            
            // データを保存
            localStorage.setItem('userLevel', JSON.stringify(userLevel));
            
            if (leveledUp) {
                showLevelUpNotification(newLevel);
                
                // レベル20到達でグランドマスターバッジ
                if (newLevel === 20) {
                    awardBadge('grand_master');
                }
            }
            
            return leveledUp;
        }

        function showLevelUpNotification(newLevel) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-xl shadow-2xl z-50 bounce-in';
            notification.innerHTML = `
                <div class="text-center">
                    <div class="text-4xl mb-2">🎉</div>
                    <div class="text-xl font-bold mb-1">レベルアップ！</div>
                    <div class="text-2xl font-bold">Lv.${newLevel}</div>
                    <div class="text-sm opacity-90 mt-1">おめでとうございます！</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 紙吹雪効果
            createConfetti();
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // バッジ獲得処理
        function awardBadge(badgeId) {
            if (!achievements.includes(badgeId)) {
                achievements.push(badgeId);
                localStorage.setItem('achievements', JSON.stringify(achievements));
                showBadgeNotification(badgeId);
            }
        }

        function showBadgeNotification(badgeId) {
            const badge = badgeDefinitions[badgeId];
            if (!badge) return;
            
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4 rounded-xl shadow-lg z-50 bounce-in';
            notification.innerHTML = `
                <div class="flex items-center">
                    <div class="text-3xl mr-3">${badge.icon}</div>
                    <div>
                        <div class="font-bold">バッジ獲得！</div>
                        <div class="text-sm">${badge.name}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // バッジ獲得チェック
        function checkAndAwardBadges(quizData) {
            const newBadges = [];
            
            // 初回挑戦
            if (quizHistory.length === 1) {
                awardBadge('first_quiz');
                newBadges.push('first_quiz');
            }
            
            // 満点獲得
            if (quizData.accuracy === 100) {
                awardBadge('perfect_score');
                newBadges.push('perfect_score');
                
                // 5回連続満点チェック
                const recentQuizzes = quizHistory.slice(-5);
                if (recentQuizzes.length === 5 && recentQuizzes.every(q => q.accuracy === 100)) {
                    awardBadge('perfectionist');
                    newBadges.push('perfectionist');
                }
            }
            
            // 連続学習バッジ
            updateLearningStreak();
            if (learningStreak.current === 3) {
                awardBadge('streak_3');
                newBadges.push('streak_3');
            } else if (learningStreak.current === 7) {
                awardBadge('streak_7');
                newBadges.push('streak_7');
            } else if (learningStreak.current === 30) {
                awardBadge('streak_30');
                newBadges.push('streak_30');
            }
            
            // カテゴリ専門バッジ
            const categoryStats = {};
            quizHistory.forEach(quiz => {
                quiz.questions.forEach(q => {
                    if (q.isCorrect) {
                        const category = q.category || '未分類';
                        categoryStats[category] = (categoryStats[category] || 0) + 1;
                    }
                });
            });
            
            if (categoryStats['SEO'] >= 10) {
                awardBadge('seo_master');
                newBadges.push('seo_master');
            }
            if (categoryStats['AI'] >= 10) {
                awardBadge('ai_expert');
                newBadges.push('ai_expert');
            }
            
            // 時間帯バッジ
            const hour = new Date().getHours();
            if (hour < 6) {
                awardBadge('early_bird');
                newBadges.push('early_bird');
            } else if (hour >= 22) {
                awardBadge('night_owl');
                newBadges.push('night_owl');
            }
            
            // 探検家バッジ（全カテゴリ挑戦）
            const attemptedCategories = [...new Set(quizHistory.map(q => q.category))];
            const totalCategories = [...new Set(originalQuestions.map(q => q.category || '未分類'))];
            if (attemptedCategories.length >= totalCategories.length && totalCategories.length > 0) {
                awardBadge('explorer');
                newBadges.push('explorer');
            }
            
            // 知識探求者バッジ
            const totalQuestionsAnswered = quizHistory.reduce((sum, quiz) => sum + quiz.total, 0);
            if (totalQuestionsAnswered >= 100) {
                awardBadge('knowledge_seeker');
                newBadges.push('knowledge_seeker');
            }
            
            return newBadges;
        }

        // 学習継続管理
        function updateLearningStreak() {
            const today = new Date().toDateString();
            const lastDate = learningStreak.lastDate;
            
            if (lastDate) {
                const lastDateObj = new Date(lastDate);
                const todayObj = new Date(today);
                const diffDays = Math.floor((todayObj - lastDateObj) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    // 連続学習
                    learningStreak.current++;
                } else if (diffDays > 1) {
                    // 7日ぶりの復帰チェック
                    if (diffDays === 7) {
                        awardBadge('comeback_kid');
                    }
                    // 連続記録リセット
                    learningStreak.current = 1;
                }
                // diffDays === 0 の場合（同日）は何もしない
            } else {
                // 初回学習
                learningStreak.current = 1;
            }
            
            // 最高記録更新
            if (learningStreak.current > learningStreak.best) {
                learningStreak.best = learningStreak.current;
            }
            
            learningStreak.lastDate = today;
            localStorage.setItem('learningStreak', JSON.stringify(learningStreak));
        }

        // 今日の目標管理
        function initializeDailyGoals() {
            const today = new Date().toDateString();
            
            if (!dailyGoals[today]) {
                dailyGoals[today] = {
                    goals: {
                        quizzes: 3,      // クイズ完了数
                        questions: 20,   // 問題回答数
                        xp: 100         // XP獲得量
                    },
                    progress: {
                        quizzesCompleted: 0,
                        questionsAnswered: 0,
                        xpEarned: 0
                    }
                };
                
                // 古いデータを削除（7日以上前）
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                Object.keys(dailyGoals).forEach(date => {
                    if (new Date(date) < weekAgo) {
                        delete dailyGoals[date];
                    }
                });
                
                localStorage.setItem('dailyGoals', JSON.stringify(dailyGoals));
            }
        }

        function updateDailyGoals(quizData, xpGained) {
            const today = new Date().toDateString();
            initializeDailyGoals();
            
            const todayGoals = dailyGoals[today];
            todayGoals.progress.quizzesCompleted++;
            todayGoals.progress.questionsAnswered += quizData.total;
            todayGoals.progress.xpEarned += xpGained;
            
            localStorage.setItem('dailyGoals', JSON.stringify(dailyGoals));
            
            // 目標達成チェック
            checkDailyGoalCompletion(todayGoals);
        }

        function checkDailyGoalCompletion(todayGoals) {
            const { goals, progress } = todayGoals;
            
            if (progress.quizzesCompleted >= goals.quizzes && 
                progress.questionsAnswered >= goals.questions && 
                progress.xpEarned >= goals.xp) {
                
                showDailyGoalCompletionNotification();
            }
        }

        function showDailyGoalCompletionNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-green-400 to-blue-500 text-white p-4 rounded-xl shadow-lg z-50 bounce-in';
            notification.innerHTML = `
                <div class="flex items-center">
                    <div class="text-2xl mr-3">🎯</div>
                    <div>
                        <div class="font-bold">今日の目標達成！</div>
                        <div class="text-sm opacity-90">素晴らしい学習成果です！</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 画像管理機能
        function showImageUploadModal() {
            document.getElementById('imageUploadModal').classList.remove('hidden');
            
            // 現在の画像URLを表示
            const currentImageUrl = localStorage.getItem('customHeroImageUrl');
            if (currentImageUrl) {
                document.getElementById('heroImageUrl').value = currentImageUrl;
            }
        }
        
        function closeImageUploadModal() {
            document.getElementById('imageUploadModal').classList.add('hidden');
            document.getElementById('heroImageUrl').value = '';
        }
        
        function updateHeroImage() {
            const imageUrl = document.getElementById('heroImageUrl').value.trim();
            
            if (!imageUrl) {
                alert('画像URLを入力してください');
                return;
            }
            
            // URLの妥当性をチェック
            if (!isValidImageUrl(imageUrl)) {
                alert('有効な画像URLを入力してください（jpg, jpeg, png, gif, webp形式）');
                return;
            }
            
            // 画像の読み込みテスト
            const testImage = new Image();
            testImage.onload = function() {
                // 画像の読み込みが成功した場合
                localStorage.setItem('customHeroImageUrl', imageUrl);
                loadCustomHeroImage();
                closeImageUploadModal();
                alert('ヒーロー画像を更新しました！');
            };
            testImage.onerror = function() {
                alert('画像の読み込みに失敗しました。URLを確認してください。');
            };
            testImage.src = imageUrl;
        }
        
        function resetToDefaultImage() {
            localStorage.removeItem('customHeroImageUrl');
            loadCustomHeroImage();
            closeImageUploadModal();
            alert('デフォルトのイラストに戻しました！');
        }
        
        function loadCustomHeroImage() {
            const customImageUrl = localStorage.getItem('customHeroImageUrl');
            const defaultIllustration = document.getElementById('defaultIllustration');
            const customHeroImage = document.getElementById('customHeroImage');
            
            if (customImageUrl) {
                // カスタム画像を表示
                customHeroImage.src = customImageUrl;
                customHeroImage.classList.remove('hidden');
                defaultIllustration.classList.add('hidden');
            } else {
                // デフォルトのSVGイラストを表示
                customHeroImage.classList.add('hidden');
                defaultIllustration.classList.remove('hidden');
            }
        }
        
        function isValidImageUrl(url) {
            try {
                const urlObj = new URL(url);
                const pathname = urlObj.pathname.toLowerCase();
                return pathname.match(/\.(jpg|jpeg|png|gif|webp)$/);
            } catch (e) {
                return false;
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // テーマ初期化
            initializeTheme();
            
            // キーボードサポート初期化
            initializeKeyboardSupport();
            
            // フォーカス管理初期化
            manageFocus();
            
            // Phase 2: ゲーミフィケーション初期化
            initializeDailyGoals();
            
            // 保存されたログイン状態を確認
            const savedUser = loadUserSession();
            if (savedUser) {
                currentUser = savedUser;
                console.log('ログイン状態を復元しました:', currentUser.name);
                showMainApp();
            } else {
                // ログイン画面を表示
                document.getElementById('loginContainer').classList.remove('hidden');
            }
            
            // 広告の初期化
            if (typeof adsbygoogle !== 'undefined') {
                (adsbygoogle = window.adsbygoogle || []).push({});
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967bbabfd3161450',t:'MTc1Mzk1MDU4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
