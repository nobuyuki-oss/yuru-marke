<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #00c4cc 0%, #7b68ee 50%, #ff6b9d 100%);
            min-height: 100vh;
        }
        .canva-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .quiz-card {
            background: linear-gradient(135deg, #00c4cc 0%, #7b68ee 100%);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        .quiz-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
            pointer-events: none;
        }
        .option-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .option-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 196, 204, 0.3);
            border-color: #00c4cc;
        }
        .option-selected {
            background: linear-gradient(135deg, #00c4cc, #7b68ee) !important;
            color: white !important;
            border-color: #00c4cc !important;
        }
        .correct { 
            background: linear-gradient(135deg, #00d4aa, #00c4cc) !important; 
            animation: correctPulse 0.6s ease-out;
        }
        .incorrect { 
            background: linear-gradient(135deg, #ff6b9d, #ff8a80) !important; 
            animation: incorrectShake 0.6s ease-out;
        }
        .progress-bar {
            background: linear-gradient(90deg, #00c4cc, #7b68ee, #ff6b9d);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        .canva-button {
            background: linear-gradient(135deg, #00c4cc, #7b68ee);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .canva-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 196, 204, 0.4);
        }
        .canva-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .canva-button:hover::before {
            left: 100%;
        }
        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        .shape:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
        .shape:nth-child(2) { top: 20%; right: 10%; animation-delay: 2s; }
        .shape:nth-child(3) { bottom: 20%; left: 20%; animation-delay: 4s; }
        .shape:nth-child(4) { bottom: 10%; right: 20%; animation-delay: 1s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <!-- Floating Background Shapes -->
    <div class="floating-shapes">
        <div class="shape">
            <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
                <circle cx="40" cy="40" r="30" fill="#00c4cc"/>
            </svg>
        </div>
        <div class="shape">
            <svg width="60" height="60" viewBox="0 0 60 60" fill="none">
                <rect x="15" y="15" width="30" height="30" rx="8" fill="#7b68ee"/>
            </svg>
        </div>
        <div class="shape">
            <svg width="70" height="70" viewBox="0 0 70 70" fill="none">
                <polygon points="35,10 55,50 15,50" fill="#ff6b9d"/>
            </svg>
        </div>
        <div class="shape">
            <svg width="50" height="50" viewBox="0 0 50 50" fill="none">
                <path d="M25 5 L45 25 L25 45 L5 25 Z" fill="#00d4aa"/>
            </svg>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-8 max-w-4xl relative z-10">
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginContainer" class="canva-card rounded-3xl p-8 mb-8 text-center">
            <div class="mb-6">
                <h1 class="text-5xl font-bold bg-gradient-to-r from-cyan-500 to-purple-600 bg-clip-text text-transparent mb-3">
                    âœ¨ ã‚†ã‚‹ãƒãƒ¼ã‚±é“å ´
                </h1>
                <p class="text-gray-700 text-lg font-medium">æ§˜ã€…ãªå½¢å¼ã®å•é¡Œã«æŒ‘æˆ¦ã—ã‚ˆã†ï¼</p>
            </div>
            
            <div class="max-w-md mx-auto">
                <div class="mb-6">
                    <input type="email" id="loginEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent mb-3">
                    <input type="password" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div class="space-y-3">
                    <button onclick="login()" class="canva-button text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg">
                        ğŸ”‘ ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                    <button onclick="showRegister()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg transition-all">
                        ğŸ“ æ–°è¦ç™»éŒ²
                    </button>
                    <button onclick="loginAsGuest()" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg transition-all">
                        ğŸ‘¤ ã‚²ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³ï¼ˆç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼‰
                    </button>
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-2">ğŸ’¡ ãƒ‡ãƒ¢ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h3>
                    <div class="text-sm text-blue-700 space-y-1">
                        <p><strong>ç„¡æ–™ãƒ—ãƒ©ãƒ³:</strong> demo@free.com / password123</p>
                        <p><strong>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³:</strong> demo@premium.com / password123</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°è¦ç™»éŒ²ç”»é¢ -->
        <div id="registerContainer" class="hidden canva-card rounded-3xl p-8 mb-8 text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“ æ–°è¦ç™»éŒ²</h2>
            
            <div class="max-w-md mx-auto">
                <div class="mb-6 space-y-3">
                    <input type="text" id="registerName" placeholder="ãŠåå‰" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <input type="email" id="registerEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <input type="password" id="registerPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div class="space-y-3">
                    <button onclick="register()" class="canva-button text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg">
                        âœ¨ ç™»éŒ²ã™ã‚‹ï¼ˆç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼‰
                    </button>
                    <button onclick="showLogin()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg transition-all">
                        â† ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰ -->
        <div id="mainHeader" class="hidden">
            <div class="flex justify-between items-center mb-8">
                <div class="canva-card rounded-3xl px-8 py-6">
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-cyan-500 to-purple-600 bg-clip-text text-transparent mb-2">
                        âœ¨ ã‚†ã‚‹ãƒãƒ¼ã‚±é“å ´
                    </h1>
                    <p class="text-gray-700 text-lg font-medium">æ§˜ã€…ãªå½¢å¼ã®å•é¡Œã«æŒ‘æˆ¦ã—ã‚ˆã†ï¼</p>
                </div>
                
                <div class="canva-card rounded-3xl px-6 py-4">
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div class="font-semibold text-gray-800" id="userNameDisplay">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</div>
                            <div class="flex items-center">
                                <span id="userPlanDisplay" class="text-sm px-3 py-1 rounded-full bg-blue-100 text-blue-600">ç„¡æ–™ãƒ—ãƒ©ãƒ³</span>
                                <button id="upgradeButton" onclick="showUpgradeModal()" class="hidden ml-2 text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full hover:shadow-lg transition-all">
                                    â­ ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                                </button>
                            </div>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all">
                            ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="upgradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="canva-card rounded-3xl p-8 max-w-md mx-4">
                <div class="text-center">
                    <div class="text-6xl mb-4">â­</div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h2>
                    <p class="text-gray-600 mb-6">ä¸­ç´šãƒ»ä¸Šç´šå•é¡Œã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã•ã‚‰ãªã‚‹ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚’ï¼</p>
                    
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl p-6 mb-6">
                        <div class="text-4xl font-bold mb-2">Â¥980</div>
                        <div class="text-lg">æœˆé¡</div>
                    </div>
                    
                    <div class="text-left mb-6 space-y-2">
                        <div class="flex items-center">
                            <span class="text-green-500 mr-2">âœ“</span>
                            <span>å…¨é›£æ˜“åº¦ã®å•é¡Œã«ã‚¢ã‚¯ã‚»ã‚¹</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-green-500 mr-2">âœ“</span>
                            <span>è©³ç´°ãªè§£èª¬ä»˜ã</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-green-500 mr-2">âœ“</span>
                            <span>é€²æ—ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-green-500 mr-2">âœ“</span>
                            <span>å„ªå…ˆã‚µãƒãƒ¼ãƒˆ</span>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="upgradeToPremium()" class="canva-button text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg">
                            ğŸ’³ ä»Šã™ãã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                        </button>
                        <button onclick="closeUpgradeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-8 py-3 rounded-2xl font-semibold w-full shadow-lg transition-all">
                            å¾Œã§
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-4">â€» ãƒ‡ãƒ¢ç‰ˆã§ã¯å®Ÿéš›ã®èª²é‡‘ã¯ç™ºç”Ÿã—ã¾ã›ã‚“</p>
                </div>
            </div>
        </div>

        <!-- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šãƒ‘ãƒãƒ« -->
        <div id="setupPanel" class="hidden canva-card rounded-3xl p-8 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ“Š å•é¡Œãƒ‡ãƒ¼ã‚¿è¨­å®š</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ URL</label>
                    <input type="text" id="spreadsheetUrl" 
                           placeholder="https://docs.google.com/spreadsheets/d/..." 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <p class="text-sm text-gray-500 mt-1">â€» ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¯ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ãŒé–²è¦§å¯èƒ½ã€ã«è¨­å®šã—ã¦ãã ã•ã„</p>
                </div>
                
                <!-- ã‚¯ã‚¤ã‚ºè¨­å®š -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“š ã‚«ãƒ†ã‚´ãƒªé¸æŠ</label>
                        <select id="categorySelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="all">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">å•é¡Œæ•°: <span id="categoryCount">0</span>å•</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">â­ é›£æ˜“åº¦é¸æŠ</label>
                        <select id="difficultySelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="all">ã™ã¹ã¦ã®é›£æ˜“åº¦</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">é¸æŠä¸­: <span id="difficultyCount">0</span>å•</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”€ å•é¡Œã®é †åº</label>
                        <select id="shuffleMode" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="normal">é †ç•ªé€šã‚Š</option>
                            <option value="shuffle">ãƒ©ãƒ³ãƒ€ãƒ </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">â±ï¸ åˆ¶é™æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                        <select id="timeLimit" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="0">åˆ¶é™ãªã—</option>
                            <option value="5">5åˆ†</option>
                            <option value="10">10åˆ†</option>
                            <option value="15">15åˆ†</option>
                            <option value="30">30åˆ†</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="loadSampleData()" class="canva-button text-white px-8 py-4 rounded-2xl font-semibold text-lg shadow-lg">
                        ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                    </button>
                    <button onclick="loadFromSpreadsheet()" class="canva-button text-white px-8 py-4 rounded-2xl font-semibold text-lg shadow-lg">
                        ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿
                    </button>
                </div>
                
                <div id="startQuizSection" class="hidden mt-8 text-center">
                    <button onclick="startQuiz()" class="canva-button text-white px-12 py-5 rounded-2xl font-bold text-xl shadow-2xl transform hover:scale-105">
                        ğŸš€ ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹
                    </button>
                </div>
                <div id="loadingMessage" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"></div>
                        <span class="text-blue-700">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                </div>
                
                <!-- ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼çµæœ -->
                <div id="validationResults" class="hidden mt-4"></div>
            </div>
        </div>

        <!-- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šæ‰‹é † -->
        <div class="canva-card rounded-3xl p-6 mb-6 border-l-4 border-yellow-400">
            <h3 class="text-lg font-semibold text-yellow-800 mb-3">âš ï¸ é‡è¦ï¼šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…¬é–‹è¨­å®š</h3>
            <ol class="text-sm text-yellow-700 space-y-2">
                <li><strong>1.</strong> Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li><strong>2.</strong> ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ãŒé–²è¦§å¯èƒ½ã€ã«è¨­å®š</li>
                <li><strong>3.</strong> ã€Œãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã€ã—ã¦URLã‚’å–å¾—</li>
                <li><strong>4.</strong> ä¸Šè¨˜ã®URLå…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘</li>
            </ol>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿å½¢å¼èª¬æ˜ -->
        <div class="canva-card rounded-3xl p-6 mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“‹ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå½¢å¼</h3>
            <div class="mb-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                <div class="flex items-start">
                    <span class="text-blue-500 mr-2 mt-1">ğŸ’¡</span>
                    <div>
                        <h4 class="font-medium text-blue-800 mb-1">è§£èª¬æ©Ÿèƒ½ã«ã¤ã„ã¦</h4>
                        <p class="text-blue-700 text-sm">Gåˆ—ã«è§£èª¬ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å•é¡Œã®è©³ç´°ãªè§£èª¬ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚è§£èª¬ã¯ç©ºæ¬„ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">åˆ—A: å•é¡Œæ–‡</th>
                            <th class="px-4 py-2 text-left">åˆ—B: å•é¡Œã‚¿ã‚¤ãƒ—</th>
                            <th class="px-4 py-2 text-left">åˆ—C: é¸æŠè‚¢</th>
                            <th class="px-4 py-2 text-left">åˆ—D: æ­£è§£</th>
                            <th class="px-4 py-2 text-left">åˆ—E: ã‚«ãƒ†ã‚´ãƒª</th>
                            <th class="px-4 py-2 text-left">åˆ—F: é›£æ˜“åº¦</th>
                            <th class="px-4 py-2 text-left">åˆ—G: è§£èª¬ï¼ˆä»»æ„ï¼‰</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600">
                        <tr class="border-t">
                            <td class="px-4 py-2">æ—¥æœ¬ã®é¦–éƒ½ã¯ï¼Ÿ</td>
                            <td class="px-4 py-2">single</td>
                            <td class="px-4 py-2">æ±äº¬,å¤§é˜ª,äº¬éƒ½,åå¤å±‹</td>
                            <td class="px-4 py-2">æ±äº¬</td>
                            <td class="px-4 py-2">ä¸€èˆ¬çŸ¥è­˜</td>
                            <td class="px-4 py-2">åˆç´š</td>
                            <td class="px-4 py-2">æ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚1868å¹´ã®æ˜æ²»ç¶­æ–°ä»¥é™ã€æ”¿æ²»ãƒ»çµŒæ¸ˆã®ä¸­å¿ƒåœ°ã¨ã—ã¦ç™ºå±•ã—ã¦ãã¾ã—ãŸã€‚</td>
                        </tr>
                        <tr class="border-t">
                            <td class="px-4 py-2">åœ°çƒã¯ä¸¸ã„</td>
                            <td class="px-4 py-2">truefalse</td>
                            <td class="px-4 py-2">â—‹,Ã—</td>
                            <td class="px-4 py-2">â—‹</td>
                            <td class="px-4 py-2">ç§‘å­¦</td>
                            <td class="px-4 py-2">åˆç´š</td>
                            <td class="px-4 py-2">åœ°çƒã¯çƒä½“ï¼ˆå³å¯†ã«ã¯å›è»¢æ¥•å††ä½“ï¼‰ã®å½¢ã‚’ã—ã¦ã„ã¾ã™ã€‚å¤ä»£ã‚®ãƒªã‚·ãƒ£æ™‚ä»£ã‹ã‚‰çŸ¥ã‚‰ã‚Œã¦ã„ãŸäº‹å®Ÿã§ã™ã€‚</td>
                        </tr>
                        <tr class="border-t">
                            <td class="px-4 py-2">ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã¯ï¼Ÿ</td>
                            <td class="px-4 py-2">multiple</td>
                            <td class="px-4 py-2">JavaScript,Python,HTML,CSS</td>
                            <td class="px-4 py-2">JavaScript,Python</td>
                            <td class="px-4 py-2">IT</td>
                            <td class="px-4 py-2">ä¸­ç´š</td>
                            <td class="px-4 py-2">JavaScriptã¨Pythonã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™ã€‚HTMLã¯ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—è¨€èªã€CSSã¯ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆè¨€èªã§ã€å³å¯†ã«ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-sm text-gray-600">
                <p><strong>å•é¡Œã‚¿ã‚¤ãƒ—:</strong> singleï¼ˆæŠä¸€é¸æŠï¼‰, multipleï¼ˆè¤‡æ•°é¸æŠï¼‰, truefalseï¼ˆâ—‹Ã—å•é¡Œï¼‰</p>
                <p><strong>é¸æŠè‚¢:</strong> ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: é¸æŠè‚¢1,é¸æŠè‚¢2,é¸æŠè‚¢3ï¼‰</p>
                <p><strong>æ­£è§£:</strong> è¤‡æ•°é¸æŠã®å ´åˆã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆä¾‹: æ­£è§£1,æ­£è§£2ï¼‰</p>
            </div>
        </div>

        <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
        <div id="quizContainer" class="hidden">
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¨ã‚¿ã‚¤ãƒãƒ¼ -->
            <div class="canva-card rounded-3xl p-6 mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-600">é€²æ—</span>
                    <div class="flex items-center space-x-4">
                        <span id="progressText" class="text-sm font-medium text-gray-600">1 / 10</span>
                        <div id="timerDisplay" class="hidden flex items-center text-sm font-medium text-orange-600">
                            <span class="mr-1">â±ï¸</span>
                            <span id="timeRemaining">10:00</span>
                        </div>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressBar" class="progress-bar h-3 rounded-full" style="width: 10%"></div>
                </div>
            </div>

            <!-- å•é¡Œã‚«ãƒ¼ãƒ‰ -->
            <div class="quiz-card rounded-2xl p-8 text-white mb-6">
                <div class="text-center">
                    <div id="questionNumber" class="text-lg font-medium mb-4 opacity-90">å•é¡Œ 1</div>
                    <h2 id="questionText" class="text-2xl font-bold mb-6 leading-relaxed">å•é¡Œæ–‡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</h2>
                    <div class="flex justify-center space-x-3 mb-4">
                        <div id="questionCategory" class="inline-block bg-white bg-opacity-20 px-4 py-2 rounded-full text-sm font-medium">
                            ä¸€èˆ¬çŸ¥è­˜
                        </div>
                        <div id="questionDifficulty" class="inline-block bg-white bg-opacity-20 px-4 py-2 rounded-full text-sm font-medium">
                            åˆç´š
                        </div>
                        <div id="questionType" class="inline-block bg-white bg-opacity-20 px-4 py-2 rounded-full text-sm font-medium">
                            æŠä¸€é¸æŠ
                        </div>
                    </div>
                </div>
            </div>

            <!-- é¸æŠè‚¢ -->
            <div id="optionsContainer" class="space-y-4 mb-8">
                <!-- é¸æŠè‚¢ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>

            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div class="flex justify-between items-center">
                <button id="prevButton" onclick="previousQuestion()" 
                        class="bg-gray-400 hover:bg-gray-500 text-white px-8 py-4 rounded-2xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                    â† å‰ã®å•é¡Œ
                </button>
                <button id="nextButton" onclick="nextQuestion()" 
                        class="canva-button text-white px-8 py-4 rounded-2xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                    æ¬¡ã®å•é¡Œ â†’
                </button>
            </div>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="resultContainer" class="hidden">
            <div class="canva-card rounded-3xl p-8 text-center mb-6">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">ã‚¯ã‚¤ã‚ºå®Œäº†ï¼</h2>
                <div class="text-6xl font-bold text-purple-600 mb-2" id="finalScore">8/10</div>
                <p class="text-gray-600 mb-6">ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="correctCount">8</div>
                        <div class="text-sm text-green-600">æ­£è§£</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-red-600" id="incorrectCount">2</div>
                        <div class="text-sm text-red-600">ä¸æ­£è§£</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="accuracyRate">80%</div>
                        <div class="text-sm text-blue-600">æ­£ç­”ç‡</div>
                    </div>
                </div>
                <!-- ç§°å·è¡¨ç¤º -->
                <div id="achievementSection" class="hidden mb-8">
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-3xl p-6 text-center text-white shadow-2xl">
                        <div class="text-4xl mb-3">ğŸ†</div>
                        <h3 class="text-2xl font-bold mb-2">ç§°å·ç²å¾—ï¼</h3>
                        <div id="achievementTitle" class="text-3xl font-bold mb-2">ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°é“å ´ åˆç´šãƒã‚¹ã‚¿ãƒ¼</div>
                        <p id="achievementDescription" class="text-lg opacity-90">åˆç´šãƒ¬ãƒ™ãƒ«ã®å•é¡Œã‚’å…¨å•æ­£è§£ã—ã¾ã—ãŸï¼</p>
                    </div>
                </div>
                
                <div class="flex justify-center space-x-4">
                    <button onclick="showDetailedResults()" 
                            class="canva-button text-white px-8 py-4 rounded-2xl font-semibold shadow-lg">
                        ğŸ“Š è©³ç´°çµæœã‚’è¦‹ã‚‹
                    </button>
                    <button onclick="restartQuiz()" 
                            class="canva-button text-white px-8 py-4 rounded-2xl font-semibold shadow-lg">
                        ğŸ”„ ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
                    </button>
                </div>
            </div>
            
            <!-- è©³ç´°çµæœ -->
            <div id="detailedResults" class="hidden canva-card rounded-3xl p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸ“Š å•é¡Œåˆ¥è©³ç´°çµæœ</h3>
                <div id="detailedResultsList" class="space-y-4">
                    <!-- è©³ç´°çµæœãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
                <div class="text-center mt-6">
                    <button onclick="hideDetailedResults()" 
                            class="bg-gray-400 hover:bg-gray-500 text-white px-8 py-4 rounded-2xl font-semibold transition-all shadow-lg">
                        â† æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let questions = [];
        let originalQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let selectedAnswers = new Set();
        let timerInterval = null;
        let timeRemaining = 0;
        let quizStartTime = null;

        // æ–‡å­—ã®æ­£è¦åŒ–é–¢æ•°ï¼ˆâ—‹Ã—ã®æ–‡å­—åŒ–ã‘ã‚’é˜²ãï¼‰
        function normalizeText(text) {
            return text.trim()
                .replace(/â—‹/g, 'â—‹')  // å…¨è§’â—‹ã«çµ±ä¸€
                .replace(/Ã—/g, 'Ã—')  // å…¨è§’Ã—ã«çµ±ä¸€
                .replace(/â—¯/g, 'â—‹')  // â—¯ã‚’â—‹ã«å¤‰æ›
                .replace(/âœ•/g, 'Ã—')  // âœ•ã‚’Ã—ã«å¤‰æ›
                .replace(/\s+/g, ' '); // è¤‡æ•°ã®ç©ºç™½ã‚’1ã¤ã«
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
        let currentUser = null;
        
        // ãƒ‡ãƒ¢ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
        const demoUsers = {
            'demo@free.com': { name: 'ãƒ•ãƒªãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼', plan: 'free', password: 'password123' },
            'demo@premium.com': { name: 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼', plan: 'premium', password: 'password123' }
        };

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        const sampleQuestions = [
            {
                question: "æ—¥æœ¬ã®é¦–éƒ½ã¯ã©ã“ã§ã™ã‹ï¼Ÿ",
                type: "single",
                options: ["æ±äº¬", "å¤§é˜ª", "äº¬éƒ½", "åå¤å±‹"],
                correct: ["æ±äº¬"],
                category: "ä¸€èˆ¬çŸ¥è­˜",
                difficulty: "åˆç´š",
                explanation: "æ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚1868å¹´ã®æ˜æ²»ç¶­æ–°ä»¥é™ã€æ”¿æ²»ãƒ»çµŒæ¸ˆã®ä¸­å¿ƒåœ°ã¨ã—ã¦ç™ºå±•ã—ã¦ãã¾ã—ãŸã€‚"
            },
            {
                question: "åœ°çƒã¯ä¸¸ã„å½¢ã‚’ã—ã¦ã„ã‚‹",
                type: "truefalse",
                options: ["â—‹", "Ã—"],
                correct: ["â—‹"],
                category: "ç§‘å­¦",
                difficulty: "åˆç´š",
                explanation: "åœ°çƒã¯çƒä½“ï¼ˆå³å¯†ã«ã¯å›è»¢æ¥•å††ä½“ï¼‰ã®å½¢ã‚’ã—ã¦ã„ã¾ã™ã€‚å¤ä»£ã‚®ãƒªã‚·ãƒ£æ™‚ä»£ã‹ã‚‰çŸ¥ã‚‰ã‚Œã¦ã„ãŸäº‹å®Ÿã§ã™ã€‚"
            },
            {
                question: "ä»¥ä¸‹ã®ã†ã¡ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã¯ã©ã‚Œã§ã™ã‹ï¼Ÿï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰",
                type: "multiple",
                options: ["JavaScript", "Python", "HTML", "CSS"],
                correct: ["JavaScript", "Python"],
                category: "IT",
                difficulty: "ä¸­ç´š",
                explanation: "JavaScriptã¨Pythonã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™ã€‚HTMLã¯ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—è¨€èªã€CSSã¯ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆè¨€èªã§ã€å³å¯†ã«ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
            },
            {
                question: "1 + 1 = 2ã§ã‚ã‚‹",
                type: "truefalse",
                options: ["â—‹", "Ã—"],
                correct: ["â—‹"],
                category: "æ•°å­¦",
                difficulty: "åˆç´š",
                explanation: "åŸºæœ¬çš„ãªç®—æ•°ã®å•é¡Œã§ã™ã€‚1ã«1ã‚’è¶³ã™ã¨2ã«ãªã‚Šã¾ã™ã€‚"
            },
            {
                question: "å¯Œå£«å±±ã®æ¨™é«˜ã¯ç´„ä½•ãƒ¡ãƒ¼ãƒˆãƒ«ã§ã™ã‹ï¼Ÿ",
                type: "single",
                options: ["2,776m", "3,776m", "4,776m", "5,776m"],
                correct: ["3,776m"],
                category: "ä¸€èˆ¬çŸ¥è­˜",
                difficulty: "ä¸­ç´š",
                explanation: "å¯Œå£«å±±ã®æ¨™é«˜ã¯3,776mã§ã™ã€‚æ—¥æœ¬æœ€é«˜å³°ã®å±±ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚"
            },
            {
                question: "ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ã¯ä½•å¹´ã«ä¸€åº¦é–‹å‚¬ã•ã‚Œã¾ã™ã‹ï¼Ÿ",
                type: "single",
                options: ["2å¹´", "3å¹´", "4å¹´", "5å¹´"],
                correct: ["4å¹´"],
                category: "ã‚¹ãƒãƒ¼ãƒ„",
                difficulty: "åˆç´š",
                explanation: "ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ã¯4å¹´ã«ä¸€åº¦é–‹å‚¬ã•ã‚Œã¾ã™ã€‚å¤å­£ã¨å†¬å­£ãŒã‚ã‚Šã€ãã‚Œãã‚Œ4å¹´å‘¨æœŸã§é–‹å‚¬ã•ã‚Œã¦ã„ã¾ã™ã€‚"
            },
            {
                question: "æ°´ã®åŒ–å­¦å¼ã¯H2Oã§ã‚ã‚‹",
                type: "truefalse",
                options: ["â—‹", "Ã—"],
                correct: ["â—‹"],
                category: "ç§‘å­¦",
                difficulty: "ä¸­ç´š",
                explanation: "æ°´ã®åŒ–å­¦å¼ã¯H2Oã§ã™ã€‚æ°´ç´ åŸå­2å€‹ã¨é…¸ç´ åŸå­1å€‹ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚"
            },
            {
                question: "ä»¥ä¸‹ã®ã†ã¡ã€çƒæŠ€ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰",
                type: "multiple",
                options: ["ã‚µãƒƒã‚«ãƒ¼", "é‡çƒ", "é™¸ä¸Š", "æ°´æ³³"],
                correct: ["ã‚µãƒƒã‚«ãƒ¼", "é‡çƒ"],
                category: "ã‚¹ãƒãƒ¼ãƒ„",
                difficulty: "åˆç´š",
                explanation: "ã‚µãƒƒã‚«ãƒ¼ã¨é‡çƒã¯çƒæŠ€ã§ã™ã€‚é™¸ä¸Šã¯èµ°ã‚‹ãƒ»è·³ã¶ãƒ»æŠ•ã’ã‚‹ãªã©ã®ç«¶æŠ€ã€æ°´æ³³ã¯æ³³ãç«¶æŠ€ã§ã€çƒæŠ€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
            },
            {
                question: "é‡å­åŠ›å­¦ã®ä¸ç¢ºå®šæ€§åŸç†ã‚’æå”±ã—ãŸã®ã¯èª°ã§ã™ã‹ï¼Ÿ",
                type: "single",
                options: ["ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³", "ãƒã‚¤ã‚¼ãƒ³ãƒ™ãƒ«ã‚¯", "ã‚·ãƒ¥ãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚¬ãƒ¼", "ãƒœãƒ¼ã‚¢"],
                correct: ["ãƒã‚¤ã‚¼ãƒ³ãƒ™ãƒ«ã‚¯"],
                category: "ç§‘å­¦",
                difficulty: "ä¸Šç´š",
                explanation: "ä¸ç¢ºå®šæ€§åŸç†ã¯ãƒ´ã‚§ãƒ«ãƒŠãƒ¼ãƒ»ãƒã‚¤ã‚¼ãƒ³ãƒ™ãƒ«ã‚¯ãŒ1927å¹´ã«æå”±ã—ã¾ã—ãŸã€‚ç²’å­ã®ä½ç½®ã¨é‹å‹•é‡ã‚’åŒæ™‚ã«æ­£ç¢ºã«æ¸¬å®šã™ã‚‹ã“ã¨ã¯ã§ããªã„ã¨ã„ã†åŸç†ã§ã™ã€‚"
            },
            {
                question: "æ©Ÿæ¢°å­¦ç¿’ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰",
                type: "multiple",
                options: ["ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "æ±ºå®šæœ¨", "HTML", "ãƒ©ãƒ³ãƒ€ãƒ ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ"],
                correct: ["ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "æ±ºå®šæœ¨", "ãƒ©ãƒ³ãƒ€ãƒ ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ"],
                category: "IT",
                difficulty: "ä¸Šç´š",
                explanation: "ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€æ±ºå®šæœ¨ã€ãƒ©ãƒ³ãƒ€ãƒ ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆã¯æ©Ÿæ¢°å­¦ç¿’ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚HTMLã¯Webãƒšãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—è¨€èªã§ã€æ©Ÿæ¢°å­¦ç¿’ã¨ã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚"
            }
        ];

        // ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
        function showLogin() {
            document.getElementById('registerContainer').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
        }

        function showRegister() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('registerContainer').classList.remove('hidden');
        }

        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ‡ãƒ¢ç”¨èªè¨¼
            if (demoUsers[email] && demoUsers[email].password === password) {
                currentUser = {
                    email: email,
                    name: demoUsers[email].name,
                    plan: demoUsers[email].plan
                };
                showMainApp();
            } else {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™');
            }
        }

        function register() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ç°¡å˜ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!email.includes('@')) {
                alert('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (password.length < 6) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆãƒ‡ãƒ¢ç‰ˆï¼‰
            currentUser = {
                email: email,
                name: name,
                plan: 'free'
            };
            
            alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
            showMainApp();
        }

        function loginAsGuest() {
            currentUser = {
                email: 'guest@example.com',
                name: 'ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                plan: 'free'
            };
            showMainApp();
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainHeader').classList.add('hidden');
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showMainApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('registerContainer').classList.add('hidden');
            document.getElementById('mainHeader').classList.remove('hidden');
            document.getElementById('setupPanel').classList.remove('hidden');
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            
            const planDisplay = document.getElementById('userPlanDisplay');
            const upgradeButton = document.getElementById('upgradeButton');
            
            if (currentUser.plan === 'premium') {
                planDisplay.textContent = 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³';
                planDisplay.className = 'text-sm px-3 py-1 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white';
                upgradeButton.classList.add('hidden');
            } else {
                planDisplay.textContent = 'ç„¡æ–™ãƒ—ãƒ©ãƒ³';
                planDisplay.className = 'text-sm px-3 py-1 rounded-full bg-blue-100 text-blue-600';
                upgradeButton.classList.remove('hidden');
            }
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function upgradeToPremium() {
            // ãƒ‡ãƒ¢ç‰ˆã§ã¯å³åº§ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
            currentUser.plan = 'premium';
            alert('ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼\nä¸­ç´šãƒ»ä¸Šç´šå•é¡Œã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚');
            closeUpgradeModal();
            showMainApp();
        }

        function loadSampleData() {
            originalQuestions = [...sampleQuestions];
            const validation = validateQuestions(originalQuestions);
            showValidationResults(validation);
            
            if (validation.isValid) {
                updateCategoryOptions();
                questions = [...originalQuestions];
                document.getElementById('startQuizSection').classList.remove('hidden');
            }
        }

        function updateCategoryOptions() {
            const categorySelect = document.getElementById('categorySelect');
            const difficultySelect = document.getElementById('difficultySelect');
            
            const categories = [...new Set(originalQuestions.map(q => q.category || 'æœªåˆ†é¡'))].sort();
            const difficulties = [...new Set(originalQuestions.map(q => q.difficulty || 'æœªè¨­å®š'))].sort();
            
            // å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            categorySelect.onchange = updateDropdownOptions;
            difficultySelect.onchange = updateDropdownOptions;
            
            // åˆæœŸè¡¨ç¤º
            updateDropdownOptions();
        }

        function updateDropdownOptions() {
            const categorySelect = document.getElementById('categorySelect');
            const difficultySelect = document.getElementById('difficultySelect');
            
            const selectedCategory = categorySelect.value;
            const selectedDifficulty = difficultySelect.value;
            
            const categories = [...new Set(originalQuestions.map(q => q.category || 'æœªåˆ†é¡'))].sort();
            const difficulties = [...new Set(originalQuestions.map(q => q.difficulty || 'æœªè¨­å®š'))].sort();
            
            // ç¾åœ¨ã®é¸æŠã‚’ä¿æŒ
            const currentCategoryValue = selectedCategory;
            const currentDifficultyValue = selectedDifficulty;
            
            // ã‚«ãƒ†ã‚´ãƒªé¸æŠè‚¢ã‚’å†æ§‹ç¯‰
            categorySelect.innerHTML = '';
            
            // ã€Œã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªã€ã®å•é¡Œæ•°ã‚’è¨ˆç®—
            let allCategoryCount = originalQuestions;
            if (selectedDifficulty !== 'all') {
                allCategoryCount = allCategoryCount.filter(q => (q.difficulty || 'æœªè¨­å®š') === selectedDifficulty);
            }
            
            const allCategoryOption = document.createElement('option');
            allCategoryOption.value = 'all';
            allCategoryOption.textContent = `ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª (${allCategoryCount.length}å•)`;
            categorySelect.appendChild(allCategoryOption);
            
            // å„ã‚«ãƒ†ã‚´ãƒªã®å•é¡Œæ•°ã‚’è¨ˆç®—ï¼ˆé›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼‰
            categories.forEach(category => {
                let categoryQuestions = originalQuestions.filter(q => (q.category || 'æœªåˆ†é¡') === category);
                if (selectedDifficulty !== 'all') {
                    categoryQuestions = categoryQuestions.filter(q => (q.difficulty || 'æœªè¨­å®š') === selectedDifficulty);
                }
                
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `${category} (${categoryQuestions.length}å•)`;
                categorySelect.appendChild(option);
            });
            
            // é›£æ˜“åº¦é¸æŠè‚¢ã‚’å†æ§‹ç¯‰
            difficultySelect.innerHTML = '';
            
            // ã€Œã™ã¹ã¦ã®é›£æ˜“åº¦ã€ã®å•é¡Œæ•°ã‚’è¨ˆç®—
            let allDifficultyCount = originalQuestions;
            if (selectedCategory !== 'all') {
                allDifficultyCount = allDifficultyCount.filter(q => (q.category || 'æœªåˆ†é¡') === selectedCategory);
            }
            
            const allDifficultyOption = document.createElement('option');
            allDifficultyOption.value = 'all';
            allDifficultyOption.textContent = `ã™ã¹ã¦ã®é›£æ˜“åº¦ (${allDifficultyCount.length}å•)`;
            difficultySelect.appendChild(allDifficultyOption);
            
            // å„é›£æ˜“åº¦ã®å•é¡Œæ•°ã‚’è¨ˆç®—ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼‰
            difficulties.forEach(difficulty => {
                let difficultyQuestions = originalQuestions.filter(q => (q.difficulty || 'æœªè¨­å®š') === difficulty);
                if (selectedCategory !== 'all') {
                    difficultyQuestions = difficultyQuestions.filter(q => (q.category || 'æœªåˆ†é¡') === selectedCategory);
                }
                
                const option = document.createElement('option');
                option.value = difficulty;
                option.textContent = `${difficulty} (${difficultyQuestions.length}å•)`;
                difficultySelect.appendChild(option);
            });
            
            // é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
            categorySelect.value = currentCategoryValue;
            difficultySelect.value = currentDifficultyValue;
            
            // æœ€çµ‚çš„ãªãƒ•ã‚£ãƒ«ã‚¿çµæœã‚’è¨ˆç®—
            let filteredQuestions = originalQuestions;
            if (selectedCategory !== 'all') {
                filteredQuestions = filteredQuestions.filter(q => (q.category || 'æœªåˆ†é¡') === selectedCategory);
            }
            if (selectedDifficulty !== 'all') {
                filteredQuestions = filteredQuestions.filter(q => (q.difficulty || 'æœªè¨­å®š') === selectedDifficulty);
            }
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('categoryCount').textContent = filteredQuestions.length;
            document.getElementById('difficultyCount').textContent = filteredQuestions.length;
        }
        


        function validateQuestions(questionsToValidate) {
            const errors = [];
            const warnings = [];
            let validCount = 0;

            questionsToValidate.forEach((q, index) => {
                const questionNum = index + 1;
                
                // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
                if (!q.question || q.question.trim() === '') {
                    errors.push(`å•é¡Œ${questionNum}: å•é¡Œæ–‡ãŒç©ºã§ã™`);
                }
                if (!q.type || !['single', 'multiple', 'truefalse'].includes(q.type)) {
                    errors.push(`å•é¡Œ${questionNum}: å•é¡Œã‚¿ã‚¤ãƒ—ãŒç„¡åŠ¹ã§ã™ (single, multiple, truefalse ã®ã„ãšã‚Œã‹ã‚’æŒ‡å®š)`);
                }
                if (!q.options || q.options.length === 0) {
                    errors.push(`å•é¡Œ${questionNum}: é¸æŠè‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“`);
                }
                if (!q.correct || q.correct.length === 0) {
                    errors.push(`å•é¡Œ${questionNum}: æ­£è§£ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“`);
                }

                // é¸æŠè‚¢ã¨æ­£è§£ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆæ–‡å­—ã®æ­£è¦åŒ–å¯¾å¿œï¼‰
                if (q.options && q.correct) {
                    q.correct.forEach(correctAnswer => {
                        const normalizedCorrect = normalizeText(correctAnswer);
                        const hasMatch = q.options.some(option => normalizeText(option) === normalizedCorrect);
                        
                        if (!hasMatch) {
                            errors.push(`å•é¡Œ${questionNum}: æ­£è§£ã€Œ${correctAnswer}ã€ãŒé¸æŠè‚¢ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“`);
                        }
                    });
                }

                // å•é¡Œã‚¿ã‚¤ãƒ—åˆ¥ãƒã‚§ãƒƒã‚¯
                if (q.type === 'truefalse' && q.options && q.options.length !== 2) {
                    warnings.push(`å•é¡Œ${questionNum}: â—‹Ã—å•é¡Œã¯é¸æŠè‚¢ãŒ2ã¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™`);
                }
                if (q.type === 'single' && q.correct && q.correct.length > 1) {
                    warnings.push(`å•é¡Œ${questionNum}: æŠä¸€é¸æŠå•é¡Œã®æ­£è§£ã¯1ã¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™`);
                }

                if (errors.length === 0) validCount++;
            });

            return {
                isValid: errors.length === 0,
                totalQuestions: questionsToValidate.length,
                validQuestions: validCount,
                errors: errors,
                warnings: warnings
            };
        }

        function showValidationResults(validation) {
            const container = document.getElementById('validationResults');
            container.innerHTML = '';
            
            if (validation.errors.length === 0 && validation.warnings.length === 0) {
                container.innerHTML = `
                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <span class="text-green-600 mr-2">âœ…</span>
                            <span class="text-green-700 font-medium">ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å®Œäº†: ${validation.totalQuestions}å•ã™ã¹ã¦æ­£å¸¸ã§ã™</span>
                        </div>
                    </div>
                `;
            } else {
                let html = '<div class="space-y-3">';
                
                if (validation.errors.length > 0) {
                    html += `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="font-medium text-red-800 mb-2">âŒ ã‚¨ãƒ©ãƒ¼ (${validation.errors.length}ä»¶)</div>
                            <ul class="text-sm text-red-700 space-y-1">
                                ${validation.errors.map(error => `<li>â€¢ ${error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (validation.warnings.length > 0) {
                    html += `
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="font-medium text-yellow-800 mb-2">âš ï¸ è­¦å‘Š (${validation.warnings.length}ä»¶)</div>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                ${validation.warnings.map(warning => `<li>â€¢ ${warning}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
            }
            
            container.classList.remove('hidden');
        }

        async function loadFromSpreadsheet() {
            const url = document.getElementById('spreadsheetUrl').value.trim();
            if (!url) {
                alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’æŠ½å‡º
                const sheetId = extractSheetId(url);
                if (!sheetId) {
                    throw new Error('ç„¡åŠ¹ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã§ã™');
                }
                
                // CSVå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå…¬é–‹è¨­å®šãŒå¿…è¦ï¼‰
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                
                document.getElementById('loadingMessage').classList.remove('hidden');
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const parsedQuestions = parseCSV(csvText);
                
                if (parsedQuestions.length === 0) {
                    throw new Error('å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                originalQuestions = parsedQuestions;
                const validation = validateQuestions(originalQuestions);
                showValidationResults(validation);
                
                document.getElementById('loadingMessage').classList.add('hidden');
                
                if (validation.isValid) {
                    updateCategoryOptions();
                    questions = [...originalQuestions];
                    document.getElementById('startQuizSection').classList.remove('hidden');
                    alert(`${questions.length}å•ã®å•é¡Œã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`);
                } else {
                    alert(`ãƒ‡ãƒ¼ã‚¿ã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚${validation.errors.length}ä»¶ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚`);
                }
                
            } catch (error) {
                document.getElementById('loadingMessage').classList.add('hidden');
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                alert(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}\n\nç¢ºèªäº‹é …:\n1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ãŒé–²è¦§å¯èƒ½ã€ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹\n2. URLãŒæ­£ã—ã„ã‹\n3. ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹`);
            }
        }

        function extractSheetId(url) {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const questions = [];
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
            const startIndex = lines[0].includes('å•é¡Œæ–‡') ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // CSVã®è¡Œã‚’è§£æï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
                const columns = parseCSVLine(line);
                
                if (columns.length >= 4) {
                    const [questionText, type, optionsStr, correctStr, categoryStr, difficultyStr, explanationStr] = columns;
                    
                    if (questionText && type && optionsStr && correctStr) {
                        const options = optionsStr.split(',').map(opt => normalizeText(opt));
                        const correct = correctStr.split(',').map(ans => normalizeText(ans));
                        const category = categoryStr ? categoryStr.trim() : 'æœªåˆ†é¡';
                        const difficulty = difficultyStr ? difficultyStr.trim() : 'æœªè¨­å®š';
                        const explanation = explanationStr ? explanationStr.trim() : '';
                        
                        questions.push({
                            question: questionText.trim(),
                            type: type.trim(),
                            options: options,
                            correct: correct,
                            category: category,
                            difficulty: difficulty,
                            explanation: explanation
                        });
                    }
                }
            }
            
            return questions;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function startQuiz() {
            if (originalQuestions.length === 0) {
                alert('å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            // ã‚«ãƒ†ã‚´ãƒªã¨é›£æ˜“åº¦ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const selectedCategory = document.getElementById('categorySelect').value;
            const selectedDifficulty = document.getElementById('difficultySelect').value;
            let filteredQuestions = [...originalQuestions];
            
            if (selectedCategory !== 'all') {
                filteredQuestions = filteredQuestions.filter(q => (q.category || 'æœªåˆ†é¡') === selectedCategory);
            }
            
            if (selectedDifficulty !== 'all') {
                filteredQuestions = filteredQuestions.filter(q => (q.difficulty || 'æœªè¨­å®š') === selectedDifficulty);
            }
            
            // ãƒ—ãƒ©ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯
            if (currentUser.plan === 'free') {
                const restrictedQuestions = filteredQuestions.filter(q => 
                    (q.difficulty || 'æœªè¨­å®š') === 'ä¸­ç´š' || (q.difficulty || 'æœªè¨­å®š') === 'ä¸Šç´š'
                );
                
                if (restrictedQuestions.length > 0) {
                    const freeQuestions = filteredQuestions.filter(q => (q.difficulty || 'æœªè¨­å®š') === 'åˆç´š');
                    
                    if (freeQuestions.length === 0) {
                        alert('é¸æŠã•ã‚ŒãŸæ¡ä»¶ã®å•é¡Œã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³é™å®šã§ã™ã€‚\nç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ã¯åˆç´šå•é¡Œã®ã¿ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚');
                        showUpgradeModal();
                        return;
                    } else {
                        const confirmResult = confirm(
                            `é¸æŠã•ã‚ŒãŸæ¡ä»¶ã«ã¯ä¸­ç´šãƒ»ä¸Šç´šå•é¡ŒãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚\n` +
                            `ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ã¯åˆç´šå•é¡Œï¼ˆ${freeQuestions.length}å•ï¼‰ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚\n\n` +
                            `åˆç´šå•é¡Œã®ã¿ã§ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ`
                        );
                        
                        if (!confirmResult) {
                            return;
                        }
                        
                        filteredQuestions = freeQuestions;
                    }
                }
            }
            
            if (filteredQuestions.length === 0) {
                alert('é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã«å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¨­å®šã®ç¢ºèª
            const shuffleMode = document.getElementById('shuffleMode').value;
            if (shuffleMode === 'shuffle') {
                questions = shuffleArray(filteredQuestions);
            } else {
                questions = [...filteredQuestions];
            }

            // ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
            const timeLimitMinutes = parseInt(document.getElementById('timeLimit').value);
            if (timeLimitMinutes > 0) {
                timeRemaining = timeLimitMinutes * 60; // ç§’ã«å¤‰æ›
                document.getElementById('timerDisplay').classList.remove('hidden');
                startTimer();
            } else {
                document.getElementById('timerDisplay').classList.add('hidden');
            }

            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('quizContainer').classList.remove('hidden');
            
            currentQuestionIndex = 0;
            userAnswers = [];
            selectedAnswers.clear();
            quizStartTime = new Date();
            
            displayQuestion();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert('æ™‚é–“åˆ‡ã‚Œã§ã™ï¼ã‚¯ã‚¤ã‚ºã‚’çµ‚äº†ã—ã¾ã™ã€‚');
                    showResults();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timeRemaining').textContent = display;
            
            // æ®‹ã‚Šæ™‚é–“ãŒå°‘ãªããªã£ãŸã‚‰è‰²ã‚’å¤‰æ›´
            const timerElement = document.getElementById('timerDisplay');
            if (timeRemaining <= 60) {
                timerElement.className = timerElement.className.replace('text-orange-600', 'text-red-600');
            } else if (timeRemaining <= 300) {
                timerElement.className = timerElement.className.replace('text-orange-600', 'text-yellow-600');
            }
        }

        function displayQuestion() {
            const question = questions[currentQuestionIndex];
            selectedAnswers.clear();
            
            // å•é¡Œæƒ…å ±ã®æ›´æ–°
            document.getElementById('questionNumber').textContent = `å•é¡Œ ${currentQuestionIndex + 1}`;
            document.getElementById('questionText').textContent = question.question;
            
            // å•é¡Œã‚¿ã‚¤ãƒ—ã€ã‚«ãƒ†ã‚´ãƒªã€é›£æ˜“åº¦ã®è¡¨ç¤º
            const typeText = {
                'single': 'æŠä¸€é¸æŠ',
                'multiple': 'è¤‡æ•°é¸æŠ',
                'truefalse': 'â—‹Ã—å•é¡Œ'
            };
            document.getElementById('questionType').textContent = typeText[question.type] || 'æŠä¸€é¸æŠ';
            document.getElementById('questionCategory').textContent = question.category || 'æœªåˆ†é¡';
            document.getElementById('questionDifficulty').textContent = question.difficulty || 'æœªè¨­å®š';
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${currentQuestionIndex + 1} / ${questions.length}`;
            
            // é¸æŠè‚¢ã®ç”Ÿæˆ
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button w-full bg-white hover:bg-gray-50 text-gray-800 p-4 rounded-lg border-2 border-gray-200 text-left font-medium';
                button.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-sm font-bold mr-4">
                            ${String.fromCharCode(65 + index)}
                        </span>
                        <span>${option}</span>
                    </div>
                `;
                
                button.onclick = () => selectOption(button, option, question.type);
                container.appendChild(button);
            });
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.getElementById('prevButton').disabled = currentQuestionIndex === 0;
            const nextButton = document.getElementById('nextButton');
            nextButton.textContent = currentQuestionIndex === questions.length - 1 ? 'çµæœã‚’è¦‹ã‚‹' : 'æ¬¡ã®å•é¡Œ â†’';
            
            // è¤‡æ•°é¸æŠä»¥å¤–ã¯æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆå›ç­”å¾Œã«æœ‰åŠ¹åŒ–ï¼‰
            if (question.type === 'single' || question.type === 'truefalse') {
                nextButton.disabled = true;
                nextButton.style.opacity = '0.5';
            } else {
                nextButton.disabled = false;
                nextButton.style.opacity = '1';
            }
        }

        function selectOption(button, option, type) {
            if (type === 'single' || type === 'truefalse') {
                // å˜ä¸€é¸æŠï¼šä»–ã®é¸æŠã‚’è§£é™¤
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('option-selected');
                });
                
                button.classList.add('option-selected');
                
                selectedAnswers.clear();
                selectedAnswers.add(option);
                
                // å³åº§ã«æ­£èª¤åˆ¤å®šã‚’è¡¨ç¤º
                showAnswerFeedback(option, type);
                
            } else if (type === 'multiple') {
                // è¤‡æ•°é¸æŠï¼šãƒˆã‚°ãƒ«
                if (selectedAnswers.has(option)) {
                    selectedAnswers.delete(option);
                    button.classList.remove('option-selected');
                } else {
                    selectedAnswers.add(option);
                    button.classList.add('option-selected');
                }
            }
        }

        function showAnswerFeedback(selectedOption, type) {
            const question = questions[currentQuestionIndex];
            const correctAnswers = question.correct;
            
            // å˜ä¸€é¸æŠãƒ»â—‹Ã—å•é¡Œã®å ´åˆã®ã¿å³åº§ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            if (type === 'single' || type === 'truefalse') {
                const isCorrect = correctAnswers.includes(selectedOption);
                
                // å…¨ã¦ã®é¸æŠè‚¢ã«æ­£èª¤ã‚’è¡¨ç¤º
                document.querySelectorAll('.option-button').forEach(btn => {
                    const optionText = btn.querySelector('span:last-child').textContent;
                    
                    if (correctAnswers.includes(optionText)) {
                        btn.classList.add('correct');
                        btn.classList.remove('option-button');
                    } else if (optionText === selectedOption && !isCorrect) {
                        btn.classList.add('incorrect');
                        btn.classList.remove('option-button');
                    }
                    
                    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                    btn.disabled = true;
                    btn.style.pointerEvents = 'none';
                });
                
                // è§£èª¬ã‚’è¡¨ç¤ºï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã®ã¿ï¼‰
                if (currentUser.plan === 'premium' && question.explanation) {
                    setTimeout(() => {
                        showExplanation(question.explanation, isCorrect);
                    }, 1000);
                }
                
                // æ¬¡ã®å•é¡Œãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                setTimeout(() => {
                    document.getElementById('nextButton').disabled = false;
                    document.getElementById('nextButton').style.opacity = '1';
                }, 1500);
            }
        }

        function showExplanation(explanation, isCorrect) {
            // æ—¢å­˜ã®è§£èª¬ã‚’å‰Šé™¤
            const existingExplanation = document.getElementById('explanationCard');
            if (existingExplanation) {
                existingExplanation.remove();
            }
            
            const explanationCard = document.createElement('div');
            explanationCard.id = 'explanationCard';
            explanationCard.className = `mt-6 p-4 rounded-lg border-l-4 ${isCorrect ? 'bg-green-50 border-green-400' : 'bg-blue-50 border-blue-400'}`;
            explanationCard.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0 mr-3">
                        <span class="text-2xl">${isCorrect ? 'âœ…' : 'ğŸ’¡'}</span>
                    </div>
                    <div>
                        <h4 class="font-semibold ${isCorrect ? 'text-green-800' : 'text-blue-800'} mb-2">
                            ${isCorrect ? 'æ­£è§£ã§ã™ï¼' : 'è§£èª¬'}
                        </h4>
                        <p class="${isCorrect ? 'text-green-700' : 'text-blue-700'}">${explanation}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('optionsContainer').appendChild(explanationCard);
        }

        function nextQuestion() {
            // å›ç­”ã‚’ä¿å­˜
            userAnswers[currentQuestionIndex] = Array.from(selectedAnswers);
            
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showResults();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
                
                // å‰ã®å›ç­”ã‚’å¾©å…ƒ
                if (userAnswers[currentQuestionIndex]) {
                    selectedAnswers = new Set(userAnswers[currentQuestionIndex]);
                    
                    document.querySelectorAll('.option-button').forEach(button => {
                        const optionText = button.querySelector('span:last-child').textContent;
                        if (selectedAnswers.has(optionText)) {
                            button.classList.add('option-selected');
                        }
                    });
                }
            }
        }

        function showResults() {
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.remove('hidden');
            
            let correctCount = 0;
            
            questions.forEach((question, index) => {
                const userAnswer = userAnswers[index] || [];
                const correctAnswer = question.correct;
                
                // é…åˆ—ã®å†…å®¹ã‚’æ¯”è¼ƒ
                const isCorrect = arraysEqual(userAnswer.sort(), correctAnswer.sort());
                if (isCorrect) correctCount++;
            });
            
            const totalQuestions = questions.length;
            const incorrectCount = totalQuestions - correctCount;
            const accuracy = Math.round((correctCount / totalQuestions) * 100);
            
            document.getElementById('finalScore').textContent = `${correctCount}/${totalQuestions}`;
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('incorrectCount').textContent = incorrectCount;
            document.getElementById('accuracyRate').textContent = `${accuracy}%`;
            
            // ç§°å·ãƒã‚§ãƒƒã‚¯ï¼ˆæº€ç‚¹ã®å ´åˆã®ã¿ï¼‰
            if (correctCount === totalQuestions) {
                checkAndShowAchievement();
            }
        }
        
        function checkAndShowAchievement() {
            const selectedCategory = document.getElementById('categorySelect').value;
            const selectedDifficulty = document.getElementById('difficultySelect').value;
            
            let achievementTitle = '';
            let achievementDescription = '';
            
            // ã‚«ãƒ†ã‚´ãƒªã¨é›£æ˜“åº¦ã«åŸºã¥ã„ã¦ç§°å·ã‚’æ±ºå®š
            if (selectedCategory !== 'all' && selectedDifficulty !== 'all') {
                // ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ»é›£æ˜“åº¦
                achievementTitle = `${selectedCategory} ${selectedDifficulty}ãƒã‚¹ã‚¿ãƒ¼`;
                achievementDescription = `${selectedCategory}ã®${selectedDifficulty}ãƒ¬ãƒ™ãƒ«å•é¡Œã‚’å…¨å•æ­£è§£ã—ã¾ã—ãŸï¼`;
            } else if (selectedCategory !== 'all') {
                // ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªï¼ˆå…¨é›£æ˜“åº¦ï¼‰
                achievementTitle = `${selectedCategory} ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ`;
                achievementDescription = `${selectedCategory}ã®å…¨é›£æ˜“åº¦å•é¡Œã‚’åˆ¶è¦‡ã—ã¾ã—ãŸï¼`;
            } else if (selectedDifficulty !== 'all') {
                // ç‰¹å®šã®é›£æ˜“åº¦ï¼ˆå…¨ã‚«ãƒ†ã‚´ãƒªï¼‰
                achievementTitle = `${selectedDifficulty} ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³`;
                achievementDescription = `${selectedDifficulty}ãƒ¬ãƒ™ãƒ«ã®å…¨ã‚«ãƒ†ã‚´ãƒªå•é¡Œã‚’åˆ¶è¦‡ã—ã¾ã—ãŸï¼`;
            } else {
                // å…¨å•é¡Œ
                achievementTitle = 'ã‚°ãƒ©ãƒ³ãƒ‰ãƒã‚¹ã‚¿ãƒ¼';
                achievementDescription = 'ã™ã¹ã¦ã®å•é¡Œã‚’å®Œç’§ã«è§£ç­”ã—ã¾ã—ãŸï¼çœŸã®é“å ´ãƒã‚¹ã‚¿ãƒ¼ã§ã™ï¼';
            }
            
            // ç§°å·è¡¨ç¤º
            document.getElementById('achievementTitle').textContent = achievementTitle;
            document.getElementById('achievementDescription').textContent = achievementDescription;
            document.getElementById('achievementSection').classList.remove('hidden');
        }

        function showDetailedResults() {
            document.getElementById('detailedResults').classList.remove('hidden');
            const container = document.getElementById('detailedResultsList');
            container.innerHTML = '';
            
            questions.forEach((question, index) => {
                const userAnswer = userAnswers[index] || [];
                const correctAnswer = question.correct;
                const isCorrect = arraysEqual(userAnswer.sort(), correctAnswer.sort());
                
                const resultCard = document.createElement('div');
                resultCard.className = `border rounded-lg p-4 ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                
                const typeText = {
                    'single': 'æŠä¸€é¸æŠ',
                    'multiple': 'è¤‡æ•°é¸æŠ',
                    'truefalse': 'â—‹Ã—å•é¡Œ'
                };
                
                let explanationHtml = '';
                if (currentUser.plan === 'premium' && question.explanation) {
                    explanationHtml = `
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                            <div class="flex items-start">
                                <span class="text-blue-500 mr-2 mt-1">ğŸ’¡</span>
                                <div>
                                    <h5 class="font-medium text-blue-800 mb-1">è§£èª¬</h5>
                                    <p class="text-blue-700 text-sm">${question.explanation}</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (currentUser.plan === 'free') {
                    explanationHtml = `
                        <div class="mt-4 p-3 bg-gray-50 rounded-lg border-l-4 border-gray-300">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-gray-400 mr-2">ğŸ”’</span>
                                    <span class="text-gray-600 text-sm">è§£èª¬ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³é™å®šã§ã™</span>
                                </div>
                                <button onclick="showUpgradeModal()" class="text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full hover:shadow-lg transition-all">
                                    ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                                </button>
                            </div>
                        </div>
                    `;
                }

                resultCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-lg ${isCorrect ? 'text-green-600' : 'text-red-600'} mr-2">
                                ${isCorrect ? 'âœ…' : 'âŒ'}
                            </span>
                            <span class="font-medium text-gray-800">å•é¡Œ ${index + 1}</span>
                            <span class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-600 rounded">${question.category || 'æœªåˆ†é¡'}</span>
                            <span class="ml-1 px-2 py-1 text-xs bg-purple-100 text-purple-600 rounded">${question.difficulty || 'æœªè¨­å®š'}</span>
                            <span class="ml-1 px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">${typeText[question.type]}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p class="text-gray-800 font-medium mb-2">${question.question}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-3">
                        <div>
                            <span class="font-medium text-gray-600">ã‚ãªãŸã®å›ç­”:</span>
                            <div class="mt-1">
                                ${userAnswer.length > 0 ? 
                                    userAnswer.map(ans => `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1 mb-1">${ans}</span>`).join('') : 
                                    '<span class="text-gray-400">æœªå›ç­”</span>'
                                }
                            </div>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">æ­£è§£:</span>
                            <div class="mt-1">
                                ${correctAnswer.map(ans => `<span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded mr-1 mb-1">${ans}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                    ${explanationHtml}
                `;
                
                container.appendChild(resultCard);
            });
        }

        function hideDetailedResults() {
            document.getElementById('detailedResults').classList.add('hidden');
        }

        function arraysEqual(a, b) {
            return a.length === b.length && a.every((val, index) => val === b[index]);
        }

        function restartQuiz() {
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('detailedResults').classList.add('hidden');
            document.getElementById('achievementSection').classList.add('hidden');
            document.getElementById('setupPanel').classList.remove('hidden');
            document.getElementById('validationResults').classList.add('hidden');
            document.getElementById('startQuizSection').classList.add('hidden');
            
            currentQuestionIndex = 0;
            userAnswers = [];
            selectedAnswers.clear();
            timeRemaining = 0;
            quizStartTime = null;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9638a800109c969c',t:'MTc1MzI0NzI2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
